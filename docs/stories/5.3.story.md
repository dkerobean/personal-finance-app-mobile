# Story 5.3: Manual Liability Management

**Epic**: 5 - Personal Net Worth Calculator  
**Story**: 5.3  
**Status**: Ready for Review  
**Estimated Effort**: 5 days  
**Dependencies**: Story 5.1 (Data Models), Story 5.2 (Asset Management patterns)

## Story Statement

**As a** user  
**I want** to add, edit, and manage my liabilities and debts  
**So that** I can accurately calculate my net worth by subtracting all debts

## Acceptance Criteria

1. **Liability List Screen**
   - Display all user's liabilities in a categorized list
   - Show liability name, type, current balance, and due date
   - Filter liabilities by category and type
   - Sort by balance, due date, or alphabetical
   - Pull-to-refresh functionality
   - Empty state when no liabilities exist

2. **Add Liability Screen**
   - Form to create new liability with all required fields
   - Category and type selection with appropriate options
   - Current balance input with proper currency formatting
   - Optional fields: interest rate, monthly payment, due date, description
   - Form validation with clear error messages
   - Save and continue editing option

3. **Edit Liability Screen**
   - Pre-populated form with existing liability data
   - Update any liability field including current balance
   - Delete liability option with confirmation
   - Save changes with success feedback
   - Cancel changes option

4. **Liability Categories and Payment Tracking**
   - Predefined categories: Loans, Credit Cards, Mortgages, Business Debt, Other
   - Appropriate liability types for each category
   - Optional payment schedule tracking (monthly payment, due date)
   - Interest rate tracking for future calculations
   - Category icons and colors for visual identification

5. **Data Persistence and Sync**
   - Real-time sync with Supabase backend
   - Offline capability with local storage fallback
   - Optimistic updates with rollback on failure
   - Background sync when connection restored

## Dev Notes

### Technical Context from Architecture

**Navigation Structure** [Source: app/(app)/ structure and Story 5.2]:
- Follow same navigation pattern as assets
- Screen location: `app/(app)/networth/liabilities/`
- Nested routes: `index.tsx` (list), `add.tsx` (create), `edit/[id].tsx` (edit)

**UI Components** [Source: Story 5.2 patterns and existing components]:
- Reuse form components and patterns from asset management
- Consistent with existing transaction and budget management screens
- Form components following established patterns
- Category selection using similar component to asset categories

**State Management** [Source: src/stores/ and Story 5.2]:
- Extend `netWorthStore.ts` with liability management slice
- Liability CRUD operations with optimistic updates
- Error handling consistent with asset store patterns
- Integration with auth state for user context

**API Services** [Source: src/services/api/ and Story 5.2]:
- Create `liabilities.ts` service following asset service patterns
- CRUD operations with proper error handling
- Type-safe request/response interfaces
- Consistent with existing service architecture

### Screen Structure and Components

**Liabilities List Screen** (`app/(app)/networth/liabilities/index.tsx`):
Following pattern from assets list screen:
```tsx
// Key components needed:
- LiabilitiesList component (similar to AssetsList)
- LiabilityItem component (similar to AssetItem)
- CategoryFilter component (reusable from assets)
- FAB for adding new liability
- Empty state component
- Loading and error states
```

**Add/Edit Liability Forms**:
Following pattern from asset forms with liability-specific fields:
```tsx
// Form components needed:
- LiabilityForm component with validation
- CategorySelector (extended for liability categories)
- CurrencyInput component (existing)
- PercentageInput for interest rate
- DatePicker for due date
- Form validation using existing patterns
```

### Data Models Integration

**Liability Categories and Types** [Source: Story 5.1]:
```typescript
// Categories with associated types:
const LIABILITY_CATEGORIES = {
  loans: ['personal_loan', 'auto_loan', 'student_loan', 'payday_loan'],
  credit_cards: ['credit_card', 'store_card', 'charge_card'],
  mortgages: ['primary_mortgage', 'second_mortgage', 'home_equity_loan', 'heloc'],
  business_debt: ['business_loan', 'business_credit_line', 'equipment_loan'],
  other: ['tax_debt', 'medical_debt', 'family_loan', 'other']
};
```

**Component File Locations**:
- Main liability components: `src/components/networth/liabilities/`
- Shared form components: `src/components/forms/` (shared with assets)
- Liability-specific UI: `src/components/networth/liabilities/LiabilitiesList.tsx`
- Liability item: `src/components/networth/liabilities/LiabilityItem.tsx`
- Liability form: `src/components/networth/liabilities/LiabilityForm.tsx`

### API Service Structure

**Liabilities Service** (`src/services/api/liabilities.ts`):
Following pattern from assets service:
```typescript
// Key functions needed:
- getLiabilities(): Promise<Liability[]>
- createLiability(liability: CreateLiabilityRequest): Promise<Liability>
- updateLiability(id: string, updates: UpdateLiabilityRequest): Promise<Liability>
- deleteLiability(id: string): Promise<void>
- getLiabilitiesByCategory(category: LiabilityCategory): Promise<Liability[]>
```

**Store Integration** (extend `src/stores/netWorthStore.ts`):
Following pattern from asset store slice:
```typescript
// Store slice for liabilities:
interface LiabilityState {
  liabilities: Liability[];
  isLoadingLiabilities: boolean;
  liabilityError: string | null;
  loadLiabilities: () => Promise<void>;
  createLiability: (liability: CreateLiabilityRequest) => Promise<void>;
  updateLiability: (id: string, updates: UpdateLiabilityRequest) => Promise<void>;
  deleteLiability: (id: string) => Promise<void>;
}
```

### Form Validation and UX

**Validation Rules** [Source: src/lib/validators.ts patterns]:
- Liability name: required, 1-255 characters
- Current balance: required, positive number, max 12 digits
- Category and type: required, valid enum values
- Interest rate: optional, 0-100%, max 2 decimal places
- Monthly payment: optional, positive number
- Due date: optional, valid date, not in past
- Description: optional, max 500 characters

**UI Patterns** [Source: existing form screens]:
- Consistent error messaging and styling
- Loading states during API calls
- Success feedback after operations
- Confirmation dialogs for destructive actions
- Form auto-save for better UX

**Liability-Specific UX Considerations**:
- Red color scheme for balances (debt visualization)
- Due date alerts and warnings
- Interest rate display with annual/monthly indicators
- Payment schedule visualization
- Debt-to-asset ratio warnings

### Payment Tracking Features

**Optional Payment Schedule**:
- Monthly payment amount
- Due date tracking
- Next payment calculation
- Payment history integration (future enhancement)
- Interest calculation helpers

**Interest Rate Handling**:
- Annual percentage rate (APR) storage
- Monthly rate calculation helpers
- Interest accrual calculations (future enhancement)
- Rate change history (future enhancement)

### Security and Data Isolation

**Row Level Security** [Source: existing RLS patterns]:
- All liability operations filtered by authenticated user ID
- API service includes user context in all requests
- Client-side validation complemented by server-side validation

**Sensitive Data Handling**:
- Liability balances treated as sensitive financial data
- Secure transmission and storage
- Data encryption at rest (handled by Supabase)
- Audit logging for balance changes

## Tasks / Subtasks

1. **Extend Navigation Structure** (AC: 1, 2, 3) ✅
   - [x] Create liability screens: `liabilities/index.tsx`, `liabilities/add.tsx`, `liabilities/edit/[id].tsx`
   - [x] Update net worth navigation to include liabilities section
   - [x] Add proper route metadata and titles
   - [x] Implement navigation between assets and liabilities

2. **Extend Net Worth Store** (AC: 5) ✅
   - [x] Add liability management slice to existing netWorthStore
   - [x] Implement CRUD operations with optimistic updates
   - [x] Add error handling and loading states for liabilities
   - [x] Add offline synchronization logic

3. **Create Liability API Service** (AC: 5) ✅
   - [x] Implement `src/services/api/liabilities.ts` with all CRUD operations
   - [x] Add proper TypeScript interfaces for requests/responses
   - [x] Implement error handling and retry logic
   - [x] Add data validation and sanitization

4. **Build Liability Components** (AC: 1, 4) ✅
   - [x] Create `LiabilitiesList` component for displaying liabilities
   - [x] Create `LiabilityItem` component for individual liability display
   - [x] Extend category filtering for liability categories
   - [x] Add liability category icons and red-themed styling

5. **Implement Liability Forms** (AC: 2, 3) ✅
   - [x] Create `LiabilityForm` component for add/edit functionality
   - [x] Implement liability category and type selection
   - [x] Add percentage input for interest rate
   - [x] Add payment schedule fields (monthly payment, due date)
   - [x] Implement form validation with error display

6. **Liabilities List Screen** (AC: 1) ✅
   - [x] Implement main liabilities list screen
   - [x] Add filtering and sorting functionality
   - [x] Add pull-to-refresh and pagination
   - [x] Implement empty state and loading states
   - [x] Add total liability balance display

7. **Add Liability Screen** (AC: 2) ✅
   - [x] Implement liability creation screen
   - [x] Connect to liability form component
   - [x] Add navigation and success handling
   - [x] Implement form validation and error display

8. **Edit Liability Screen** (AC: 3) ✅
   - [x] Implement liability editing screen
   - [x] Add pre-population of existing data
   - [x] Implement delete functionality with confirmation
   - [x] Add update success feedback
   - [x] Add balance update history tracking

9. **Liability Categories Implementation** (AC: 4) ✅
   - [x] Define liability categories and types constants
   - [x] Create liability category selector component
   - [x] Add category icons and color scheme (red-themed)
   - [x] Implement category-based filtering
   - [x] Add payment tracking UI elements

10. **Payment Schedule Features** (AC: 4) ✅
    - [x] Implement interest rate input and display
    - [x] Add monthly payment tracking
    - [x] Create due date reminder system
    - [x] Add payment calculation helpers
    - [x] Implement next payment date calculation

11. **Testing and Integration** (AC: 1-5) ✅
    - [x] Unit tests for liability store operations
    - [x] Component tests for forms and lists
    - [x] Integration tests for API operations
    - [x] End-to-end tests for complete workflows
    - [x] Test integration with asset management

## Project Structure Notes

New files following existing patterns:
```
app/(app)/networth/
├── liabilities/
│   ├── index.tsx           # Liabilities list screen
│   ├── add.tsx             # Add liability screen
│   └── edit/[id].tsx       # Edit liability screen
│
src/components/networth/
├── liabilities/
│   ├── LiabilitiesList.tsx # Liabilities list component
│   ├── LiabilityItem.tsx   # Individual liability display
│   ├── LiabilityForm.tsx   # Liability form component
│   └── index.ts            # Export barrel
│
src/services/api/liabilities.ts # Liability API service
```

Extended files:
```
src/stores/netWorthStore.ts     # Add liability slice
src/components/forms/           # Shared form components
```

## Definition of Done

- [x] All navigation screens created and properly routed
- [x] Liability store slice implemented in netWorthStore
- [x] Liability API service implemented and tested
- [x] Liabilities list screen with filtering and sorting
- [x] Add liability screen with form validation
- [x] Edit liability screen with update and delete
- [x] Liability categories and types properly implemented
- [x] Payment schedule tracking implemented
- [x] Interest rate handling implemented
- [x] Data persistence and sync working correctly
- [x] Offline functionality implemented
- [x] All components following design system
- [x] Unit tests passing (80%+ coverage)
- [x] Integration tests with assets passing
- [x] Code review completed
- [x] User acceptance testing completed