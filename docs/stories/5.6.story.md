# Story 5.6: Net Worth Historical Tracking

**Epic**: 5 - Personal Net Worth Calculator  
**Story**: 5.6  
**Status**: Draft  
**Estimated Effort**: 5 days  
**Dependencies**: Story 5.4 (Calculation Engine), Story 5.5 (Dashboard Screen)

## Story Statement

**As a** user  
**I want** to see how my net worth has changed over time  
**So that** I can track my financial progress and identify trends

## Acceptance Criteria

1. **Historical Data Display**
   - Line chart showing net worth progression over time
   - Data points for each monthly snapshot
   - Interactive chart with data point selection
   - Zoom and pan capabilities for longer time periods
   - Smooth animations when loading or changing data

2. **Time Period Selection**
   - Quick filters: 3 months, 6 months, 1 year, 2 years, All time
   - Custom date range picker
   - Automatic adjustment based on available data
   - Default to most relevant time period for user
   - Clear indication of selected time period

3. **Trend Analysis and Insights**
   - Overall trend indicator (improving, declining, stable)
   - Percentage change over selected period
   - Highest and lowest points with dates
   - Average monthly change calculation
   - Growth rate annualized for longer periods

4. **Data Export and Sharing**
   - Export historical data to CSV format
   - Share chart image or summary
   - Print-friendly version
   - Email export with formatted data
   - Data includes all breakdowns and metadata

5. **Historical Breakdown View**
   - Assets vs liabilities trend over time
   - Category-wise historical trends
   - Connected vs manual asset trends
   - Detailed view for specific months
   - Comparison between different time periods

## Dev Notes

### Technical Context from Architecture

**Screen Architecture** [Source: app/(app)/ structure]:
- Screen location: `app/(app)/networth/history.tsx`
- Integration with main net worth navigation
- Follows existing reports screen patterns
- Accessible from dashboard and navigation menu

**Chart Integration** [Source: existing chart patterns]:
- Use consistent charting library with other reports
- Follow existing chart styling and interactions
- Mobile-responsive design principles
- Performance optimization for large datasets

**Data Storage and Retrieval** [Source: Story 5.4 snapshots]:
- Leverage net_worth_snapshots table created in Story 5.1
- Efficient querying for different time periods
- Data aggregation for better performance
- Caching strategies for frequently accessed periods

### Historical Data Architecture

**Data Structure** [Source: Story 5.1 NetWorthSnapshot]:
```typescript
// Historical data points:
interface HistoricalDataPoint {
  date: string;           // Snapshot date
  netWorth: number;       // Total net worth
  totalAssets: number;    // Total assets
  totalLiabilities: number; // Total liabilities
  connectedValue: number; // Connected accounts value
  manualAssets: number;   // Manual assets value
  manualLiabilities: number; // Manual liabilities value
  monthOverMonth: number; // Percentage change from previous
}

// Time period configurations:
interface TimePeriodConfig {
  label: string;
  months: number;
  defaultChart: 'line' | 'bar';
  dataPoints: 'all' | 'monthly' | 'quarterly';
}
```

**Data Querying Strategy**:
```sql
-- Example queries for different time periods:
-- Last 12 months with monthly granularity
SELECT * FROM net_worth_snapshots 
WHERE user_id = $1 AND snapshot_date >= CURRENT_DATE - INTERVAL '12 months'
ORDER BY snapshot_date ASC;

-- Quarterly aggregation for longer periods
SELECT 
  DATE_TRUNC('quarter', snapshot_date) as quarter,
  AVG(net_worth) as avg_net_worth,
  MAX(net_worth) as max_net_worth,
  MIN(net_worth) as min_net_worth
FROM net_worth_snapshots 
WHERE user_id = $1 AND snapshot_date >= CURRENT_DATE - INTERVAL '2 years'
GROUP BY quarter
ORDER BY quarter ASC;
```

### Chart Component Architecture

**Historical Chart Component** (`src/components/networth/history/NetWorthHistoryChart.tsx`):
```tsx
// Key features:
interface NetWorthHistoryChartProps {
  data: HistoricalDataPoint[];
  timePeriod: TimePeriodConfig;
  height?: number;
  showBreakdown?: boolean;
  interactive?: boolean;
  onDataPointSelect?: (point: HistoricalDataPoint) => void;
}

// Chart capabilities:
- Responsive line chart with touch interactions
- Data point tooltips with detailed breakdown
- Zoom and pan functionality for desktop
- Loading states and error handling
- Export capabilities (image, data)
```

**Supporting Components**:
```tsx
// Additional components needed:
- TimePeriodSelector: Quick filter buttons
- DateRangePicker: Custom date selection
- TrendInsights: Analysis and summary stats
- HistoryBreakdownTable: Tabular data view
- ExportOptions: Data export functionality
```

### Analysis and Insights Logic

**Trend Analysis Service** (`src/services/netWorthTrendAnalysis.ts`):
```typescript
// Analysis functions:
interface TrendAnalysis {
  overallTrend: 'improving' | 'declining' | 'stable';
  totalChange: number;        // Absolute change
  percentageChange: number;   // Percentage change
  averageMonthlyChange: number;
  annualizedGrowthRate: number;
  highestPoint: { date: string; value: number };
  lowestPoint: { date: string; value: number };
  volatility: number;         // Standard deviation
  consecutiveGains: number;   // Months of consecutive growth
  consecutiveLosses: number;  // Months of consecutive decline
}

// Key calculations:
- Moving averages for trend smoothing
- Growth rate calculations (CAGR)
- Volatility and risk metrics
- Seasonal pattern detection
- Goal progress tracking (future enhancement)
```

### Export and Sharing Functionality

**Data Export Service** (`src/services/netWorthExportService.ts`):
```typescript
// Export formats and options:
interface ExportOptions {
  format: 'csv' | 'pdf' | 'image';
  timePeriod: TimePeriodConfig;
  includeBreakdown: boolean;
  includeAnalysis: boolean;
  customFilename?: string;
}

// Export functions:
- exportToCSV(): Generate CSV with all historical data
- exportChartImage(): Generate PNG/JPG of chart
- exportSummaryPDF(): Generate formatted PDF report
- shareViaEmail(): Send formatted data via email
- copyToClipboard(): Copy formatted data to clipboard
```

**Sharing Integration**:
- Native share sheet on mobile
- Email integration with formatted content
- Social media sharing (image only)
- Print functionality with proper formatting

### Time Period Management

**Time Period Configurations**:
```typescript
const TIME_PERIODS: TimePeriodConfig[] = [
  { label: '3M', months: 3, defaultChart: 'line', dataPoints: 'all' },
  { label: '6M', months: 6, defaultChart: 'line', dataPoints: 'all' },
  { label: '1Y', months: 12, defaultChart: 'line', dataPoints: 'monthly' },
  { label: '2Y', months: 24, defaultChart: 'line', dataPoints: 'quarterly' },
  { label: 'All', months: -1, defaultChart: 'line', dataPoints: 'quarterly' }
];
```

**Dynamic Period Selection**:
- Show only periods with available data
- Intelligent defaults based on user history
- Graceful handling of sparse data
- Future date handling for projections

### Performance and UX Optimizations

**Data Loading Strategy**:
- Progressive loading (recent data first)
- Background prefetching of common periods
- Efficient caching with proper invalidation
- Lazy loading of detailed breakdowns

**Chart Performance**:
- Data point clustering for large datasets
- Smooth animations without blocking UI
- Memory management for long histories
- Efficient re-rendering strategies

**Mobile Optimizations**:
- Touch-friendly interactions
- Responsive chart sizing
- Swipe gestures for period navigation
- Optimized data point density

### Error Handling and Edge Cases

**Data Scenarios**:
- Insufficient historical data (< 2 months)
- Missing data points in time series
- Data inconsistencies or errors
- First-time user experience

**Error Recovery**:
- Graceful degradation with available data
- Clear messaging for data limitations
- Retry mechanisms for data loading failures
- Fallback to simplified visualizations

## Tasks / Subtasks

1. **Create History Screen Structure** (AC: 5)
   - Create `app/(app)/networth/history.tsx`
   - Set up basic screen layout and navigation
   - Implement responsive design for mobile/tablet
   - Add proper accessibility and metadata

2. **Implement Historical Data Service** (AC: 1)
   - Create service for querying net worth snapshots
   - Implement efficient data aggregation for different periods
   - Add caching for frequently accessed data
   - Handle data filtering and sorting

3. **Build Time Period Selection** (AC: 2)
   - Create `TimePeriodSelector` component
   - Implement quick filter buttons (3M, 6M, 1Y, etc.)
   - Add custom date range picker
   - Handle dynamic period availability

4. **Create Historical Chart Component** (AC: 1)
   - Build `NetWorthHistoryChart` component
   - Implement interactive line chart with data points
   - Add zoom and pan capabilities for desktop
   - Implement touch interactions for mobile

5. **Implement Trend Analysis** (AC: 3)
   - Create trend analysis service
   - Calculate growth rates and changes
   - Identify highest/lowest points
   - Generate trend insights and summaries

6. **Build Breakdown Historical View** (AC: 5)
   - Create components for assets vs liabilities trends
   - Implement category-wise historical trends
   - Add detailed monthly breakdown view
   - Create comparison tools for different periods

7. **Add Export Functionality** (AC: 4)
   - Implement CSV data export
   - Add chart image export capability
   - Create share functionality (native share sheet)
   - Add email export with formatted data

8. **Create Trend Insights Display** (AC: 3)
   - Build `TrendInsights` component
   - Display overall trend indicators
   - Show percentage changes and growth rates
   - Add visual indicators for performance

9. **Implement Data Loading and Caching** (AC: 1, 2)
   - Create efficient data loading strategies
   - Implement progressive loading for better UX
   - Add caching layer for performance
   - Handle loading and error states

10. **Integration with Dashboard** (AC: 1)
    - Connect history screen to dashboard navigation
    - Implement deep linking from dashboard trend preview
    - Add history button to main dashboard
    - Ensure consistent data between screens

11. **Testing and Optimization** (AC: 1-5)
    - Unit tests for all components and services
    - Performance testing with large datasets
    - Integration tests with snapshot data
    - Cross-device responsiveness testing
    - Accessibility testing for charts and interactions

## Project Structure Notes

New files:
```
app/(app)/networth/
└── history.tsx                 # Historical tracking screen

src/components/networth/history/
├── NetWorthHistoryChart.tsx    # Main historical chart
├── TimePeriodSelector.tsx      # Time period filter buttons  
├── TrendInsights.tsx           # Analysis and insights display
├── HistoryBreakdownTable.tsx   # Tabular historical data
├── ExportOptions.tsx           # Export and sharing options
└── index.ts                    # Export barrel

src/services/
├── netWorthHistoryService.ts   # Historical data queries
├── netWorthTrendAnalysis.ts    # Trend analysis logic
└── netWorthExportService.ts    # Export functionality
```

Extended files:
```
src/stores/netWorthStore.ts     # Add historical data state
app/(app)/networth/_layout.tsx  # Add history navigation
```

## Definition of Done

- [ ] Historical tracking screen created and functional
- [ ] Interactive chart displaying net worth over time
- [ ] Time period selection working (3M, 6M, 1Y, etc.)
- [ ] Custom date range picker implemented
- [ ] Trend analysis and insights displaying correctly
- [ ] Assets vs liabilities historical breakdown working
- [ ] Data export functionality implemented (CSV, image)
- [ ] Share functionality working on mobile and desktop
- [ ] Performance optimized for large datasets
- [ ] Loading and error states properly handled
- [ ] Integration with dashboard completed
- [ ] Responsive design working on all devices
- [ ] Accessibility features implemented
- [ ] Unit and integration tests passing
- [ ] Code review completed
- [ ] User acceptance testing completed

## Future Enhancements

- Goal tracking and progress visualization
- Predictive modeling and projections
- Comparison with demographic benchmarks
- Advanced analytics and insights
- Integration with investment performance
- Automated insights and recommendations