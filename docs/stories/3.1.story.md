# Status

Draft

---

# Story

**As a** user,
**I want** to create and manage monthly budgets for my spending categories,
**so that** I can proactively control my spending.

---

# Acceptance Criteria

1. A "Budgets" screen is available in the app's main navigation.
2. The user can create a new budget by selecting one of their spending categories and defining a monthly limit.
3. The user can view a list of all their created budgets.
4. The user can edit the monthly limit of an existing budget.
5. The user can delete a budget.

Source: `docs/prd/epic-3-budgeting-reporting-alerts.md#story-31-budget-creation--management`

---

# Tasks / Subtasks

- [ ] Budget Navigation & Screen Setup (AC: 1)
  - [ ] Add "Budgets" tab to main navigation using Expo Router [Source: architecture.md#Routing Architecture]
  - [ ] Create `app/(app)/budgets/index.tsx` screen with Gluestack UI layout [Source: architecture.md#Frontend Architecture → Component Architecture]
  - [ ] Add budget icon to tab navigation following design consistency

- [ ] Budget Creation Interface (AC: 2)
  - [ ] Create CreateBudgetModal component with category selector and amount input [Source: architecture.md#Tech Stack → UI Component Library]
  - [ ] Implement category dropdown populated from user's categories (from Epic 1) [Source: architecture.md#Data Models → Categories]
  - [ ] Add monthly amount input with numeric validation and currency formatting
  - [ ] Handle month/year selection (default to current month) [Source: architecture.md#Data Models → Budgets → month field]
  - [ ] Submit budget creation via POST /budgets API [Source: architecture.md#API Specification]

- [ ] Budget List Display (AC: 3)
  - [ ] Create BudgetsList component showing budget name, amount, and month [Source: architecture.md#Frontend Architecture → Component Architecture]
  - [ ] Fetch user budgets via GET /budgets API endpoint [Source: architecture.md#API Specification]
  - [ ] Display budgets grouped by month or in chronological order
  - [ ] Handle empty state when no budgets exist
  - [ ] Add pull-to-refresh functionality for budget list

- [ ] Budget Editing (AC: 4)
  - [ ] Create EditBudgetModal component with pre-filled amount field
  - [ ] Implement PATCH /budgets/{id} API call for updating budget amounts [Source: architecture.md#API Specification]
  - [ ] Prevent editing of category and month (only amount is editable)
  - [ ] Add validation for positive amount values
  - [ ] Show success feedback after successful edit

- [ ] Budget Deletion (AC: 5)
  - [ ] Add delete action to budget list items (swipe-to-delete or menu option)
  - [ ] Implement confirmation dialog before deletion
  - [ ] Execute DELETE /budgets/{id} API call [Source: architecture.md#API Specification]
  - [ ] Remove budget from local state and refresh UI
  - [ ] Handle deletion errors gracefully

- [ ] Backend API Implementation
  - [ ] Create GET /budgets endpoint returning user's budgets [Source: architecture.md#Components → Budgeting Service]
  - [ ] Create POST /budgets endpoint for budget creation with validation
  - [ ] Create PATCH /budgets/{id} endpoint for amount updates
  - [ ] Create DELETE /budgets/{id} endpoint with proper authorization
  - [ ] Implement RLS policies ensuring users only access their own budgets [Source: architecture.md#Backend Architecture → Authentication and Authorization]

- [ ] Database Operations
  - [ ] Implement budget CRUD operations using Budget model [Source: architecture.md#Data Models → Budgets]
  - [ ] Add unique constraint validation (user_id, category_id, month combination) [Source: architecture.md#Database Schema → Budgets Table]
  - [ ] Handle database errors and constraint violations appropriately
  - [ ] Add database indexes for efficient budget queries [Source: architecture.md#Security and Performance → Performance Optimization]

- [ ] State Management
  - [ ] Create budgetStore using Zustand pattern [Source: architecture.md#Frontend Architecture → State Management Architecture]
  - [ ] Implement budget CRUD actions and loading states
  - [ ] Add selectors for budget filtering and aggregation
  - [ ] Handle optimistic updates for better UX
  - [ ] Integrate with category store for dropdown population

- [ ] Testing
  - [ ] Unit tests: Budget validation, amount formatting, CRUD operations [Source: architecture.md#Testing Strategy → Frontend Testing]
  - [ ] Component tests: CreateBudgetModal, EditBudgetModal, BudgetsList rendering [Source: architecture.md#Testing Strategy → Test Organization]
  - [ ] Integration tests: Full budget creation and management workflow
  - [ ] Backend tests: API endpoints, RLS policies, constraint validation [Source: architecture.md#Testing Strategy → Backend Testing]

---

# Dev Notes

## Previous Story Insights
Depends on Epic 1 completion:
- Categories (Story 1.3) provide the spending categories for budget creation
- Authentication system (Stories 1.1-1.2) for user session and API security
- Transaction system (Story 1.4) will be used in subsequent budget tracking stories

## Data Models
Budget model from architecture: [Source: architecture.md#Data Models → Budgets]
```typescript
export interface Budget {
  id: string; // UUID
  user_id: string; // UUID
  category_id: string; // UUID - Links to categories from Epic 1
  amount: number; // Monthly budget limit
  month: string; // Date string like 'YYYY-MM-01' for the budget month
}
```

Category relationship for budget creation: [Source: architecture.md#Data Models → Categories]
- Budget creation requires existing categories from Epic 1 (Story 1.3)
- Only user's custom categories should be available for budget creation
- Categories provide display names and icons for budget visualization

## API Specifications
Budget management endpoints: [Source: architecture.md#API Specification]
- GET /budgets: List user's budgets with category information joined
- POST /budgets: Create new budget with validation (unique constraint)
- PATCH /budgets/{id}: Update budget amount only
- DELETE /budgets/{id}: Remove budget with proper authorization
- All endpoints require JWT authentication [Source: architecture.md#Security Requirements → Authentication Security]

## Component Specifications
Key UI components for budget management: [Source: architecture.md#Frontend Architecture → Component Architecture]
- **BudgetsScreen**: Main container with list and creation actions
- **CreateBudgetModal**: Category selection, amount input, month picker
- **EditBudgetModal**: Amount editing with pre-filled values  
- **BudgetListItem**: Individual budget display with edit/delete actions
- **CategoryPicker**: Dropdown component reusable across budget flows

## File Locations
Frontend budget management: [Source: architecture.md#Unified Project Structure → Frontend Repository]
- Screen: `app/(app)/budgets/index.tsx`
- Components: `src/components/budgets/CreateBudgetModal.tsx`, `EditBudgetModal.tsx`, `BudgetsList.tsx`
- Store: `src/stores/budgetStore.ts`
- Services: `src/services/budgetService.ts`

Backend budget system: [Source: architecture.md#Unified Project Structure → Backend Repository]
- Edge Functions: `supabase/functions/budgets-crud/`
- Database: Budget operations in shared repository pattern
- Migration: Budget table already defined in architecture

## Security Requirements
Budget data protection: [Source: architecture.md#Security Requirements]
- JWT authentication required for all budget operations [Source: architecture.md#Security Requirements → Authentication Security]
- RLS policies ensure users only access their own budgets [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- Input validation for budget amounts (positive numbers, reasonable limits)
- Prevent duplicate budgets for same category/month combination

## State Management
Budget store architecture: [Source: architecture.md#Frontend Architecture → State Management Architecture]
```typescript
interface BudgetStore {
  budgets: Budget[];
  loading: boolean;
  error: string | null;
  
  // Actions
  fetchBudgets: () => Promise<void>;
  createBudget: (budget: CreateBudgetRequest) => Promise<void>;
  updateBudget: (id: string, amount: number) => Promise<void>;
  deleteBudget: (id: string) => Promise<void>;
  
  // Selectors
  getBudgetsForMonth: (month: string) => Budget[];
  getBudgetByCategory: (categoryId: string, month: string) => Budget | undefined;
}
```

## Business Logic
Budget creation constraints:
- One budget per category per month (unique constraint)
- Budget amounts must be positive numbers
- Month format standardized as 'YYYY-MM-01' [Source: architecture.md#Data Models → Budgets]
- Default to current month for new budget creation
- Categories must exist and belong to the user

## Testing Requirements
Comprehensive budget management testing: [Source: architecture.md#Testing Strategy]
- Form validation testing (amount, category selection)
- CRUD operation testing with proper error handling
- Unique constraint violation testing
- Component interaction testing (modals, lists, navigation)
- RLS policy testing to ensure data isolation

## Technical Constraints
Performance and usability:
- Budget list should load quickly (<200ms for typical user) [Source: architecture.md#Security and Performance → Performance Optimization]
- Optimistic UI updates for better perceived performance
- Proper loading states and error handling throughout
- Responsive design using Gluestack UI components [Source: architecture.md#Tech Stack → UI Component Library]

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## QA Results

Pending QA review.