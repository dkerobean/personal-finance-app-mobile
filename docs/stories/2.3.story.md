# Status

Ready for Review

---

# Story

**As a** user,
**I want** to see my automatically synced MTN Mobile Money transactions alongside my manual entries,
**so that** I have a single, unified view of my finances.

---

# Acceptance Criteria

1. Synced MTN MoMo transactions appear in the main "All Transactions" list.
2. Synced MTN MoMo transactions are clearly identifiable from manual entries (e.g., via an MTN MoMo logo).
3. The dashboard's "Total Balance" and "Recent Transactions" widgets are updated to include data from the synced MTN MoMo account.
4. Users can change the category of a synced MTN MoMo transaction but cannot edit the amount, date, or description.

Source: `docs/prd/epic-2-automated-account-integration.md#story-23-displaying-synced-mtn-momo-transactions`

---

# Tasks / Subtasks

- [x] MTN MoMo Transaction List Updates (AC: 1)
  - [x] Modify TransactionsList component to display both manual and synced MTN MoMo transactions [Source: architecture.md#Frontend Architecture → Component Architecture]
  - [x] Update transaction query to include is_synced field in results for MTN MoMo transactions
  - [x] Ensure proper sorting by transaction_date (most recent first) regardless of sync status

- [x] MTN MoMo Visual Differentiation (AC: 2)  
  - [x] Add MTN MoMo icon/logo display for synced transactions [Source: architecture.md#Data Models → Accounts → account_type]
  - [x] Create SyncedTransactionBadge component using Gluestack UI Badge [Source: architecture.md#Tech Stack → UI Component Library]
  - [x] Show account_name for synced transactions vs "Manual" for user-entered
  - [x] Use visual styling to distinguish synced vs manual (e.g., different background tint)

- [x] Dashboard Integration (AC: 3)
  - [x] Update TotalBalanceCard calculation to include synced transactions [Source: Story 1.5 → Previous Story Insights]
  - [x] Modify RecentTransactions widget to show mixed manual/synced in chronological order
  - [x] Update transaction store selectors to handle combined data sets [Source: architecture.md#Frontend Architecture → State Management Architecture]
  - [x] Ensure real-time updates when new synced transactions arrive

- [x] Selective Editing (AC: 4)
  - [x] Create EditTransactionModal with conditional field editing based on is_synced flag
  - [x] For synced transactions: Only allow category_id updates via PATCH /transactions/{id} [Source: architecture.md#API Specification → /transactions/{id}]
  - [x] For synced transactions: Disable amount, description, transaction_date, type fields
  - [x] Show clear UI indication of which fields are editable vs read-only
  - [x] Implement category picker dropdown for synced transaction re-categorization

- [x] Backend API Updates
  - [x] Modify GET /transactions endpoint to include account info and sync status
  - [x] Update PATCH /transactions/{id} to validate edit restrictions for synced transactions
  - [x] Ensure RLS policies work correctly for mixed transaction types [Source: architecture.md#Backend Architecture → Authentication and Authorization]
  - [x] Add account join queries for displaying account_name with transactions

- [x] State Management Updates
  - [x] Update transactionStore to handle synced transaction metadata [Source: architecture.md#Frontend Architecture → State Management Architecture]
  - [x] Create selectors for synced vs manual transaction filtering
  - [x] Update balance calculation functions to include synced amounts
  - [x] Handle account data integration with transaction display

- [x] Testing
  - [x] Unit tests: Mixed transaction list rendering and sorting [Source: architecture.md#Testing Strategy → Frontend Testing]
  - [x] Component tests: SyncedTransactionBadge display and EditTransactionModal field restrictions
  - [x] Integration tests: Dashboard calculations with mixed transaction data
  - [x] User interaction tests: Category editing for synced transactions only

---

# Dev Notes

## Previous Story Insights
Requires Stories 2.1 and 2.2 completion:
- Account linking functionality (2.1) provides account_name and account_type data
- Transaction sync (2.2) populates transactions with is_synced=true and account_id associations

## Data Models
Extended transaction queries need account information: [Source: architecture.md#Data Models]
```typescript
// Extended transaction interface for display
export interface TransactionWithAccount extends Transaction {
  account?: {
    id: string;
    account_name: string;
    account_type: 'bank' | 'mobile_money';
  };
}
```

## API Specifications
Updated transaction endpoints: [Source: architecture.md#API Specification]
- GET /transactions: Include JOIN with accounts table for account_name, account_type
- PATCH /transactions/{id}: Validate that synced transactions can only update category_id
- Response format should indicate which fields are editable based on is_synced status

## Component Specifications
Key UI components needed: [Source: architecture.md#Frontend Architecture → Component Architecture]
- **SyncedTransactionBadge**: Shows bank logo/name for synced transactions
- **EditTransactionModal**: Conditional field editing based on transaction type
- **TransactionListItem**: Updated to show sync status and account info
- **CategoryPicker**: Dropdown for re-categorizing synced transactions

## File Locations
Component updates: [Source: architecture.md#Unified Project Structure → Frontend Repository]
- Update: src/components/transactions/TransactionsList.tsx
- Update: src/components/transactions/TransactionListItem.tsx
- New: src/components/transactions/SyncedTransactionBadge.tsx
- Update: src/components/transactions/EditTransactionModal.tsx
- Update: src/components/dashboard/TotalBalanceCard.tsx (from Story 1.5)
- Update: src/components/dashboard/RecentTransactions.tsx (from Story 1.5)

Backend updates: [Source: architecture.md#Unified Project Structure → Backend Repository]
- Update: supabase/functions/transactions-crud/ (GET and PATCH endpoints)
- Update: RLS policies for mixed transaction access

## Security Requirements
Data access restrictions: [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- RLS ensures users only see their own transactions (manual and synced)
- Validation prevents editing of protected fields on synced transactions
- JWT authentication required for all transaction operations [Source: architecture.md#Security Requirements → Authentication Security]

## State Management
Transaction store enhancements: [Source: architecture.md#Frontend Architecture → State Management Architecture]
```typescript
// Example store additions
interface TransactionStore {
  // ... existing state
  getSyncedTransactions: () => TransactionWithAccount[];
  getManualTransactions: () => TransactionWithAccount[];
  getTotalBalance: () => number; // Updated to include synced
  getRecentMixed: (limit: number) => TransactionWithAccount[];
}
```

## UI/UX Considerations
Visual hierarchy and clarity: [Source: architecture.md#Tech Stack → UI Component Library]
- Use Gluestack UI Badge component for sync indicators
- Consistent iconography for bank vs mobile money accounts
- Clear visual feedback for read-only fields in edit modal
- Maintain existing user experience for manual transaction management

## Testing Requirements
Test scenarios coverage: [Source: architecture.md#Testing Strategy]
- Mixed transaction list display and sorting accuracy
- Category editing restrictions enforcement
- Dashboard calculation correctness with synced data
- Visual differentiation rendering
- Error handling for invalid edit attempts on synced transactions

## Technical Constraints
Performance considerations:
- Efficient JOIN queries for transaction + account data
- Pagination support for large transaction lists
- Real-time UI updates when new synced transactions arrive
- Maintain <200ms response time for transaction list queries [Source: architecture.md#Security and Performance → Performance Optimization]

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |
| 2025-08-15 | 2.0     | Implementation completed, status updated  | James  |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Story verification completed on 2025-08-15
- All implementation components verified present and functional

### Completion Notes List
- All 6 main tasks completed with subtasks
- SyncedTransactionBadge component implemented
- Transaction editing restrictions in place
- Dashboard integration working
- Visual differentiation complete

### File List
- src/components/SyncedTransactionBadge.tsx (new)
- src/types/models.ts (modified - added MTN MoMo fields)
- src/services/api/transactions.ts (modified - account queries & restrictions)
- app/(app)/transactions/index.tsx (modified - visual differentiation)
- app/(app)/transactions/edit/[id].tsx (modified - conditional editing)
- src/components/dashboard/RecentTransactions.tsx (modified - badge integration)
- src/stores/transactionStore.ts (modified - synced selectors)
- __tests__/SyncedTransactionBadge.test.tsx (new)
- __tests__/transactionSyncIntegration.test.tsx (new)
- __tests__/transactionEditingRestrictions.test.tsx (new)
- __tests__/dashboardSyncedTransactions.test.tsx (new)

---

## QA Results

Pending QA review.