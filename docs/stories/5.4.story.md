# Story 5.4: Net Worth Calculation Engine

**Epic**: 5 - Personal Net Worth Calculator  
**Story**: 5.4  
**Status**: Ready for Review  
**Estimated Effort**: 4 days  
**Dependencies**: Story 5.1 (Data Models), Story 5.2 (Assets), Story 5.3 (Liabilities)

## Story Statement

**As a** user  
**I want** the system to automatically calculate my net worth from all sources  
**So that** I have an accurate, real-time view of my financial position

## Acceptance Criteria

1. **Real-Time Net Worth Calculation**
   - Calculate total assets from connected accounts + manual assets
   - Calculate total liabilities from manual liability entries
   - Compute net worth as: Total Assets - Total Liabilities
   - Update calculations when any component changes
   - Handle currency conversion and precision properly

2. **Multi-Source Asset Aggregation**
   - Include all connected bank account balances from Mono API
   - Include all mobile money account balances from MTN MoMo
   - Include all manually entered asset values
   - Handle inactive/closed accounts appropriately
   - Provide breakdown by source type for transparency

3. **Breakdown and Analysis**
   - Asset breakdown by category (property, investments, cash, etc.)
   - Liability breakdown by category (loans, credit cards, mortgages, etc.)
   - Account type breakdown (connected vs manual)
   - Historical change calculation (month-over-month, year-over-year)
   - Key financial ratios and metrics

4. **Periodic Snapshot Creation**
   - Automatically create monthly net worth snapshots
   - Store snapshots on the 1st of each month
   - Include breakdown data in snapshots
   - Handle timezone considerations for snapshot timing
   - Prevent duplicate snapshots for the same period

5. **Performance and Caching**
   - Cache calculated values to improve performance
   - Invalidate cache when underlying data changes
   - Optimize database queries for calculation efficiency
   - Handle large datasets gracefully
   - Provide loading states during calculations

## Dev Notes

### Technical Context from Architecture

**Service Architecture** [Source: src/services/ structure]:
- Create calculation service following existing patterns
- Integration with existing account aggregation service
- Background service for periodic snapshots
- Error handling consistent with existing services

**State Management Integration** [Source: src/stores/ patterns]:
- Extend netWorthStore with calculation functions
- Real-time updates when data changes
- Caching mechanism for expensive calculations
- Integration with existing account and transaction stores

**Database Integration** [Source: existing account models]:
- Query optimization for calculation operations
- Efficient aggregation queries
- Integration with existing account balance tracking
- Proper handling of soft-deleted records

### Calculation Logic Architecture

**Net Worth Calculation Service** (`src/services/netWorthCalculator.ts`):
Following patterns from existing services:
```typescript
// Core calculation functions:
- calculateCurrentNetWorth(): Promise<NetWorthCalculation>
- calculateAssetTotals(): Promise<AssetBreakdown>
- calculateLiabilityTotals(): Promise<LiabilityBreakdown>
- getConnectedAccountBalances(): Promise<ConnectedAccountsTotal>
- createMonthlySnapshot(): Promise<NetWorthSnapshot>
```

**Calculation Components**:
1. **Connected Accounts Total**: Sum of all active bank and MoMo account balances
2. **Manual Assets Total**: Sum of all active manually entered assets
3. **Manual Liabilities Total**: Sum of all active manually entered liabilities
4. **Net Worth**: (Connected Accounts + Manual Assets) - Manual Liabilities

### Integration with Existing Account System

**Account Balance Integration** [Source: src/types/models.ts#Account]:
```typescript
// Leverage existing account structure:
interface AccountBalance {
  accountId: string;
  balance: number;
  accountType: 'bank' | 'mobile_money';
  institutionName: string;
  isActive: boolean;
  lastSyncedAt: string;
}

// Integration points:
- Account.balance field from Mono API sync
- Account.balance field from MTN MoMo sync  
- Account.is_active for filtering
- Account.platform_source for breakdown
```

**Account Aggregation Service Integration** [Source: src/services/accountAggregator.ts]:
- Leverage existing account balance aggregation
- Ensure consistency with existing balance calculations
- Reuse existing sync status and error handling
- Maintain existing data freshness indicators

### Calculation Performance Optimization

**Caching Strategy**:
```typescript
// Cache keys and invalidation:
interface NetWorthCache {
  lastCalculated: Date;
  totalAssets: number;
  totalLiabilities: number;
  netWorth: number;
  breakdown: NetWorthBreakdown;
  ttl: number; // Time to live in minutes
}

// Cache invalidation triggers:
- Asset creation/update/deletion
- Liability creation/update/deletion
- Account balance updates from sync
- Manual cache refresh
```

**Database Query Optimization**:
- Single query for all asset totals by category
- Single query for all liability totals by category
- Join with accounts table for connected balances
- Proper indexing on user_id and is_active fields

### Snapshot Creation Logic

**Monthly Snapshot Service** (`src/services/netWorthSnapshotService.ts`):
```typescript
// Snapshot creation logic:
interface SnapshotCreationResult {
  success: boolean;
  snapshot?: NetWorthSnapshot;
  error?: string;
  skipped?: boolean; // If snapshot already exists
}

// Scheduling considerations:
- Run on 1st of each month at midnight UTC
- Handle timezone differences for users
- Prevent duplicate snapshots
- Retry logic for failed snapshots
- Batch processing for multiple users
```

**Background Processing** [Source: existing background services]:
- Integration with existing background sync service
- Scheduled execution using existing patterns
- Error handling and retry mechanisms
- Monitoring and alerting for failed snapshots

### Financial Calculation Precision

**Currency and Precision Handling**:
- Use decimal.js or similar for precise financial calculations
- Handle multiple currencies (future enhancement)
- Proper rounding for display vs storage
- Consistent precision across all calculations

**Data Validation**:
- Validate all monetary inputs are positive numbers
- Handle edge cases (zero balances, negative net worth)
- Validate date ranges for historical calculations
- Ensure data integrity across calculation pipeline

### Error Handling and Edge Cases

**Calculation Error Scenarios**:
- Missing or stale account data
- Network failures during account balance fetch
- Database connection issues
- Invalid or corrupted asset/liability data
- Timezone and date calculation edge cases

**Graceful Degradation**:
- Partial calculations when some data unavailable
- Clear error messaging for users
- Fallback to cached values when appropriate
- Retry mechanisms for temporary failures

## Tasks / Subtasks

1. **Create Net Worth Calculation Service** (AC: 1, 2) ✅
   - [x] Implement `src/services/netWorthService.ts`
   - [x] Create core calculation functions for assets, liabilities, net worth
   - [x] Integrate with existing account balance aggregation
   - [x] Add proper TypeScript interfaces and error handling

2. **Implement Asset Aggregation** (AC: 2) ✅
   - [x] Create function to aggregate all manual assets by category
   - [x] Integrate with connected account balance totals
   - [x] Handle inactive assets and accounts appropriately
   - [x] Add breakdown calculations by asset type and source

3. **Implement Liability Aggregation** (AC: 1, 3) ✅
   - [x] Create function to aggregate all manual liabilities by category
   - [x] Calculate total liability balance
   - [x] Handle inactive liabilities appropriately
   - [x] Add breakdown calculations by liability type

4. **Create Breakdown Analysis** (AC: 3) ✅
   - [x] Implement category-wise asset breakdown
   - [x] Implement category-wise liability breakdown
   - [x] Add source breakdown (connected vs manual)
   - [x] Calculate key financial ratios and metrics
   - [x] Add month-over-month change calculations

5. **Implement Caching System** (AC: 5) ✅
   - [x] Create caching mechanism for expensive calculations
   - [x] Implement cache invalidation logic
   - [x] Add cache warming strategies
   - [x] Monitor cache hit rates and performance

6. **Create Monthly Snapshot Service** (AC: 4) ✅
   - [x] Implement `src/services/netWorthSnapshotService.ts`
   - [x] Create automatic monthly snapshot creation
   - [x] Handle timezone considerations and duplicate prevention
   - [x] Add retry logic and error handling

7. **Extend Net Worth Store** (AC: 1, 5) ✅
   - [x] Add calculation functions to netWorthStore
   - [x] Implement real-time updates when data changes
   - [x] Add loading states and error handling
   - [x] Integrate caching with store state

8. **Database Query Optimization** (AC: 5) ✅
   - [x] Optimize asset aggregation queries
   - [x] Optimize liability aggregation queries
   - [x] Create efficient joined queries for full calculation
   - [x] Add proper database indexes

9. **Background Processing Integration** (AC: 4) ✅
   - [x] Create Supabase Edge Function for monthly snapshots
   - [x] Schedule monthly snapshot creation
   - [x] Add monitoring and error reporting
   - [x] Implement batch processing capabilities

10. **Testing and Validation** (AC: 1-5) ✅
    - [x] Unit tests for all calculation functions
    - [x] Integration tests with asset and liability data
    - [x] Performance tests for large datasets
    - [x] Edge case testing (zero values, missing data)
    - [x] Snapshot creation and scheduling tests

## Project Structure Notes

New files:
```
src/services/
├── netWorthCalculator.ts       # Core calculation logic
├── netWorthSnapshotService.ts  # Snapshot creation service
└── netWorthCache.ts            # Caching utilities

src/lib/
└── financialCalculations.ts    # Utility functions for precise calculations
```

Extended files:
```
src/stores/netWorthStore.ts     # Add calculation state and functions
src/services/backgroundSyncService.ts # Add snapshot scheduling
```

## Calculation Examples

**Basic Net Worth Calculation**:
```
Connected Accounts (Mono + MTN): GHS 15,000
Manual Assets (Real Estate + Car): GHS 85,000
Manual Liabilities (Mortgage + Loan): GHS 45,000

Net Worth = (15,000 + 85,000) - 45,000 = GHS 55,000
```

**Breakdown Example**:
```
Assets Breakdown:
- Connected Accounts: GHS 15,000 (15%)
- Real Estate: GHS 80,000 (80%)
- Vehicles: GHS 5,000 (5%)

Liabilities Breakdown:
- Mortgages: GHS 40,000 (89%)
- Personal Loans: GHS 5,000 (11%)
```

## Definition of Done

- [x] Net worth calculation service implemented and tested
- [x] Asset aggregation working across all sources
- [x] Liability aggregation implemented
- [x] Real-time calculation updates working
- [x] Breakdown analysis by categories implemented
- [x] Monthly snapshot creation automated
- [x] Caching system implemented and optimized
- [x] Performance optimized for large datasets
- [x] Integration with existing account system working
- [x] Background processing integrated
- [x] All calculation functions tested (unit + integration)
- [x] Edge cases handled appropriately
- [x] Error handling and graceful degradation working
- [x] Code review completed
- [x] Performance testing completed