# Status

Draft

---

# Story

**As a** returning user,
**I want** to log in securely with my email and password and remain logged in,
**so that** I can easily access my financial data.

---

# Acceptance Criteria

1. A login screen exists with fields for email and password.
2. Upon successful login, the user is redirected to the dashboard.
3. The user's session is securely persisted, so they remain logged in when they reopen the app.
4. A "Logout" button is available within the app that securely ends the session.
5. Clear error messages are shown for failed login attempts (e.g., "Invalid credentials").

Source: `docs/prd/epic-1-foundation-manual-finance-tracking-v2.md#story-12-user-login--session-management`

---

# Tasks / Subtasks

- [ ] Build Login UI (AC: 1, 5)
  - [ ] Screen `app/(auth)/login.tsx` with email/password inputs using Gluestack UI [Source: `docs/architecture.md#Frontend Architecture`]
  - [ ] Client-side validation for email format and non-empty password [Source: `docs/architecture.md#Security and Performance`]
  - [ ] Submit handler calls Supabase Auth `signInWithPassword()` and handles success/error states [Source: `docs/architecture.md#Components` → Authentication Flow]
  - [ ] Display clear error toasts/messages on invalid credentials and network errors [Source: `docs/architecture.md#Frontend Error Handling`]

- [ ] Handle Successful Login and Navigation (AC: 2)
  - [ ] On success, navigate to `app/(app)/index.tsx` (Dashboard) [Source: `docs/architecture.md#Routing Architecture`]
  - [ ] Ensure authenticated route group `/(app)` is protected via layout/session guard [Source: `docs/architecture.md#Routing Architecture`]

- [ ] Session Persistence (AC: 3)
  - [ ] Initialize Supabase auth listener for session/token changes [Source: `docs/architecture.md#Authentication Security`]
  - [ ] Persist session JWT using Expo Secure Store [Source: `docs/architecture.md#Authentication Security`]
  - [ ] Hydrate auth state from Secure Store on app launch before routing [Source: `docs/architecture.md#Frontend Architecture`]
  - [ ] Gracefully handle expired/invalid sessions by clearing storage and returning to login [Source: `docs/architecture.md#Error Handling Strategy`]

- [ ] Logout Flow (AC: 4)
  - [ ] Add `Logout` action in app settings or header [Source: `docs/architecture.md#Frontend Architecture`]
  - [ ] Call Supabase `signOut()`; clear Secure Store; reset auth store; navigate to `/(auth)/login` [Source: `docs/architecture.md#Components` → Authentication Flow]

- [ ] Testing (all AC)
  - [ ] Unit/component tests for `login.tsx` validating UI behavior and error states with Jest + RNTL [Source: `docs/architecture.md#Frontend Testing`]
  - [ ] Integration tests mocking Supabase `signInWithPassword` success/failure paths [Source: `docs/architecture.md#Testing Strategy`]
  - [ ] Optional Maestro E2E: cold start → login → dashboard visible; app relaunch maintains session [Source: `docs/architecture.md#E2E Testing`]

- [ ] Project structure and configuration
  - [ ] Supabase client in `src/services/supabaseClient.ts` (reuse from Story 1.1) [Source: `docs/architecture.md#Frontend Services Layer`]
  - [ ] Auth store `src/stores/authStore.ts` (Zustand) with session set/get actions and hydration [Source: `docs/architecture.md#State Management Architecture`]
  - [ ] Route guard in a layout (e.g., `app/(app)/_layout.tsx`) that checks auth store/session before rendering [Source: `docs/architecture.md#Routing Architecture`]

---

# Dev Notes

## Previous Story Insights
- Reuse Supabase client setup and secure storage patterns established in Story 1.1. Ensure consistency in error handling and navigation between register/verify/login flows. [Source: `docs/architecture.md#Frontend Services Layer`, `#Error Handling Strategy`]

## Data Models
- No new tables introduced; this story uses Supabase Auth session and JWT handling. [Source: `docs/architecture.md#Authentication Security`]

## API Specifications
- Supabase Auth `signInWithPassword()` for email/password login; `signOut()` for logout. Session listener to monitor auth state. [Source: `docs/architecture.md#Components` → Authentication Flow, `#Core Workflows`]
- Standardized error shape should be mapped to user-friendly messages in the UI. [Source: `docs/architecture.md#Error Handling Strategy`]

## Component Specifications
- `app/(auth)/login.tsx`: form with email/password, submit to sign-in, surface error states.
- Authenticated navigation: redirect to `/(app)` dashboard after success. [Source: `docs/architecture.md#Routing Architecture`]
- Logout action in app shell or settings to clear session and navigate to login. [Source: `docs/architecture.md#Components` → Authentication Flow]

## File Locations
- Screens: `app/(auth)/login.tsx`, dashboard at `app/(app)/index.tsx` [Source: `docs/architecture.md#Routing Architecture`]
- Services: `src/services/supabaseClient.ts` [Source: `docs/architecture.md#Frontend Services Layer`]
- State: `src/stores/authStore.ts` [Source: `docs/architecture.md#State Management Architecture`]

## Testing Requirements
- Co-locate tests with components; use Jest + RNTL for UI and integration-level mocks. [Source: `docs/architecture.md#Frontend Testing`, `#Testing Strategy`]
- E2E (optional) to verify session persistence across app relaunch with Maestro. [Source: `docs/architecture.md#E2E Testing`]

## Technical Constraints
- TypeScript + React Native (Expo), Gluestack UI; secure storage via Expo Secure Store. [Source: `docs/architecture.md#Tech Stack`, `#Authentication Security`]
- Maintain performance and smooth UX during auth transitions. [Source: `docs/architecture.md#Performance Optimization`]

## Project Structure Notes
- Ensure guards and store wiring align with the Unified Project Structure guidance. [Source: `docs/architecture.md#Unified Project Structure`]

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## QA Results

Pending QA review.



