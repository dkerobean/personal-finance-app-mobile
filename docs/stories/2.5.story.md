# Status

Draft

---

# Story

**As a** user,
**I want** my financial accounts to be updated automatically in the background,
**so that** my data is always up-to-date without manual effort.

---

# Acceptance Criteria

1. A scheduled backend task runs periodically (e.g., daily) to fetch new transactions for all linked accounts.
2. Only new transactions that have not been previously synced are added to the database.
3. The background sync is efficient and handles errors without impacting the user experience.
4. (Optional for MVP) The user receives a notification if a linked account requires re-authentication.

Source: `docs/prd/epic-2-automated-account-integration.md#story-25-background-synchronization`

---

# Tasks / Subtasks

- [ ] Scheduled Sync Service (AC: 1)
  - [ ] Create scheduled Edge Function for periodic sync execution
  - [ ] Implement daily sync job using Supabase cron functionality or external scheduler
  - [ ] Create batch processing logic to sync all user accounts sequentially
  - [ ] Add configurable sync frequency (daily default, with admin override capability)

- [ ] Incremental Sync Logic (AC: 2)
  - [ ] Implement transaction deduplication using Mono transaction references/IDs
  - [ ] Track last_synced_at timestamp per account for incremental fetching [Source: architecture.md#Data Models → Accounts]
  - [ ] Query Mono API with date filters based on last successful sync
  - [ ] Handle edge cases: overlapping time windows, transaction updates, deletions

- [ ] Error Handling and Resilience (AC: 3)
  - [ ] Implement exponential backoff for failed account syncs
  - [ ] Create sync status tracking (success/failure/in_progress per account)
  - [ ] Log sync errors without exposing sensitive data [Source: architecture.md#Development Workflow → devDebugLog]
  - [ ] Graceful degradation: Continue syncing other accounts if one fails
  - [ ] Retry mechanism for transient failures (network, rate limits)

- [ ] Re-authentication Notifications (AC: 4)
  - [ ] Detect Mono API authentication failures (401/403 errors)
  - [ ] Integrate with OneSignal for push notifications [Source: architecture.md#External APIs → OneSignal API]
  - [ ] Create notification templates for re-auth requirements
  - [ ] Handle notification delivery failures and retries
  - [ ] Provide deep-link to account re-linking flow

- [ ] Background Sync Infrastructure
  - [ ] Create SyncOrchestrator service to manage account sync queue
  - [ ] Implement sync status database table for monitoring and debugging
  - [ ] Add sync performance metrics (success rate, sync duration, transaction counts)
  - [ ] Create admin dashboard queries for sync health monitoring
  - [ ] Handle concurrent sync prevention (avoid duplicate sync jobs)

- [ ] Database Optimizations
  - [ ] Add database indexes for efficient sync queries [Source: architecture.md#Security and Performance → Performance Optimization]
  - [ ] Implement batch transaction insertion for performance
  - [ ] Add sync_status and last_sync_attempt fields to accounts table
  - [ ] Create sync_log table for audit trail and troubleshooting

- [ ] User Experience Enhancements
  - [ ] Create subtle UI indication of last sync status in account list
  - [ ] Add manual "Sync Now" capability for users who want immediate updates
  - [ ] Show sync progress/status in account management settings
  - [ ] Handle offline/online sync coordination (queue syncs when offline)

- [ ] Testing
  - [ ] Unit tests: Deduplication logic and incremental sync date calculations [Source: architecture.md#Testing Strategy → Backend Testing]
  - [ ] Integration tests: Full background sync workflow with multiple accounts
  - [ ] Load testing: Concurrent sync performance with many users/accounts
  - [ ] Error scenario testing: Network failures, auth failures, API rate limits
  - [ ] Notification delivery testing: Push notification integration

---

# Dev Notes

## Previous Story Insights
Builds on entire Epic 2 foundation:
- Account linking (2.1) provides linked accounts to sync
- Transaction sync (2.2) provides core sync logic to make periodic
- Transaction display (2.3) shows results of background sync
- Categorization (2.4) applies to new background-synced transactions

## Data Models
Extended Account model with sync metadata: [Source: architecture.md#Data Models → Accounts]
```typescript
export interface Account {
  id: string; // UUID
  user_id: string; // UUID
  account_name: string;
  account_type: 'bank' | 'mobile_money';
  balance: number;
  aggregator_account_id: string;
  last_synced_at: string; // ISO 8601 - Updated by background sync
  sync_status?: 'active' | 'auth_required' | 'error'; // New field
  last_sync_attempt?: string; // ISO 8601 - Track attempts vs success
}
```

New sync tracking model:
```typescript
export interface SyncLog {
  id: string;
  account_id: string;
  sync_started_at: string;
  sync_completed_at?: string;
  transactions_synced: number;
  status: 'success' | 'failed' | 'auth_error';
  error_message?: string;
}
```

## API Specifications
Background sync endpoints: [Source: architecture.md#API Specification]
- Internal: POST /sync/background - Triggered by scheduler
- Internal: POST /sync/account/{id} - Manual sync specific account  
- GET /accounts - Include sync_status and last_synced_at in response
- All endpoints authenticated via service account for background operations

## External API Integration
Enhanced Mono API usage: [Source: architecture.md#External APIs → Mono API]
- Implement rate limit handling (respect API limits)
- Use incremental date ranges for efficiency
- Handle authentication token refresh/expiry scenarios
- Batch API calls efficiently for multiple accounts

OneSignal integration: [Source: architecture.md#External APIs → OneSignal API]
- Documentation: https://documentation.onesignal.com/
- Backend uses App ID and REST API Key
- POST /notifications endpoint for re-auth alerts
- User segmentation for targeted notifications

## Component Specifications
Sync status UI components: [Source: architecture.md#Frontend Architecture → Component Architecture]
- **SyncStatusIndicator**: Shows last sync time and status in account list
- **ManualSyncButton**: Triggers immediate sync for specific account
- **SyncNotificationHandler**: Processes and displays sync-related notifications
- **AccountSyncSettings**: User preferences for sync frequency and notifications

## File Locations
Backend sync infrastructure: [Source: architecture.md#Unified Project Structure → Backend Repository]
- New: supabase/functions/background-sync/
- New: supabase/functions/shared/sync-orchestrator.ts
- New: supabase/functions/shared/notification-service.ts
- Update: supabase/functions/accounts-sync/ (reuse sync logic)
- New: supabase/migrations/add_sync_tracking.sql

Frontend sync UI: [Source: architecture.md#Unified Project Structure → Frontend Repository]
- New: src/components/accounts/SyncStatusIndicator.tsx
- New: src/components/accounts/ManualSyncButton.tsx
- Update: src/components/accounts/LinkedAccountsList.tsx
- New: src/services/backgroundSyncService.ts

## Security Requirements
Background sync security: [Source: architecture.md#Security Requirements]
- Service account authentication for scheduled jobs [Source: architecture.md#Security Requirements → Authentication Security]
- Secure handling of sensitive account data during sync
- Rate limiting protection to prevent API abuse [Source: architecture.md#Security Requirements → Backend Security]
- RLS ensures sync results only accessible to account owners [Source: architecture.md#Backend Architecture → Authentication and Authorization]

## State Management
Store updates for background sync: [Source: architecture.md#Frontend Architecture → State Management Architecture]
- Add sync status tracking to accountStore
- Update transaction store when background sync adds new transactions
- Handle real-time UI updates for sync status changes
- Manage sync-triggered notification state

## Infrastructure Considerations
Scheduler and monitoring: [Source: architecture.md#Deployment Architecture]
- Use Supabase cron or external scheduler (GitHub Actions, etc.)
- Monitor sync job health and performance
- Handle timezone considerations for daily sync timing
- Scale sync frequency based on user account activity patterns

## Testing Requirements
Comprehensive background sync testing: [Source: architecture.md#Testing Strategy]
- Scheduled job execution testing (mocked scheduler)
- Deduplication accuracy with overlapping sync windows
- Error recovery and retry mechanism testing
- Performance testing with large numbers of accounts and transactions
- Notification delivery and deep-linking testing

## Technical Constraints
Performance and reliability requirements:
- Background sync should not impact user-facing API performance
- Handle concurrent user and background sync operations safely
- Maintain data consistency during sync operations
- Support graceful shutdown and restart of sync processes
- Target sync completion within configurable time windows

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## QA Results

Pending QA review.