# Status

Completed

---

# Story

**As a** user,
**I want** the app to import my recent transaction history and account information from both my bank accounts (via Mono) and MTN MoMo account (via direct API),
**so that** I have an immediate and comprehensive overview of all my financial activity.

---

# Acceptance Criteria

1. For bank accounts: After successful Mono linking, automatically fetch account information and 30 days of transactions using Mono Account APIs.
2. For MTN MoMo: After successful authentication, fetch recent mobile money transactions using MTN MoMo Collections API and account balance.
3. Both data sources are stored securely with appropriate identifiers (Mono Account ID for banks, MTN Reference ID for mobile money).
4. The sync process displays platform-specific feedback (Mono branding for banks, MTN MoMo branding for mobile money).
5. Handle different error scenarios for each platform with appropriate user-friendly messages and retry mechanisms.

Source: `docs/prd/epic-2-automated-account-integration.md#story-22-dual-platform-data-sync---mono-banks--mtn-momo`

---

# Tasks / Subtasks

- [x] Dual Platform Account Data Fetching Service (AC: 1, 2)
  - [x] Create Mono API integration using mono-node package for bank account information and transactions
  - [x] Create MTN MoMo API integration using Collections API for mobile money transactions and balance
  - [x] Implement 30-day date filtering for both Mono and MTN MoMo transaction fetch requests
  - [x] Create POST /accounts/{id}/sync Edge Function supporting both platform types [Source: architecture.md#API Specification]

- [x] Dual Platform Transaction & Account Storage (AC: 3) 
  - [x] Map Mono API response format to internal Transaction and Account models for banks [Source: architecture.md#Data Models → Transactions]
  - [x] Map MTN MoMo Collections API response format to internal models for mobile money transactions
  - [x] Store account information and transactions with is_synced=true and platform-appropriate identifiers
  - [x] Implement user_id association via JWT authentication [Source: architecture.md#Security Requirements → Authentication Security]
  - [x] Handle duplicate transaction detection for both platforms (Mono transaction IDs and MTN MoMo reference IDs)

- [x] Platform-Specific User Feedback Interface (AC: 4)
  - [x] Create SyncProgressModal component with platform-specific loading indicators and branding [Source: architecture.md#Frontend Architecture → Component Architecture]
  - [x] Show platform-appropriate sync status: "Fetching bank information via Mono..." vs "Fetching MTN MoMo transactions..." 
  - [x] Display platform-specific transaction count and account details (e.g., "Imported 45 transactions from GCB Bank" vs "Imported 23 MTN MoMo transactions")
  - [x] Auto-close modal after success message or allow manual dismiss with platform context

- [x] Platform-Specific Error Handling (AC: 5)
  - [x] Implement standardized error response format [Source: architecture.md#Error Handling Strategy → Error Response Format]
  - [x] Handle Mono API rate limits, authentication errors, and network issues gracefully for bank accounts
  - [x] Handle MTN MoMo API authentication failures, API key issues, and Collections API errors for mobile money
  - [x] Show user-friendly, platform-specific error messages for different failure scenarios
  - [x] Log detailed errors to debug log for troubleshooting [Source: architecture.md#Development Workflow → devDebugLog]
  - [x] Provide retry mechanism with platform-appropriate re-authentication (Mono re-auth for banks, MTN API key regeneration for mobile money)

- [x] Dual Platform Backend Integration
  - [x] Extend Account Aggregation Service from Story 2.1 to support both platforms [Source: architecture.md#Components → Account Aggregation Service]
  - [x] Implement dual transaction transformation logic (Mono format → internal format AND MTN MoMo format → internal format)
  - [x] Add transaction batch insertion for performance across both platforms
  - [x] Create platform-specific sync services (monoSyncService.ts and mtnMomoSyncService.ts)
  - [x] Ensure RLS policies allow user to access only their synced transactions from both platforms [Source: architecture.md#Backend Architecture → Authentication and Authorization]

- [x] Dual Platform Testing
  - [x] Unit tests: Transaction format mapping and deduplication logic for both Mono and MTN MoMo [Source: architecture.md#Testing Strategy → Backend Testing]
  - [x] Integration tests: End-to-end sync flow with mock Mono API and MTN MoMo API responses [Source: architecture.md#Testing Strategy → Integration Tests]  
  - [x] Component tests: SyncProgressModal rendering and state transitions for both platforms [Source: architecture.md#Testing Strategy → Frontend Testing]
  - [x] Error scenario tests: Platform-specific network failures, API errors, invalid data handling for both Mono and MTN MoMo

---

# Dev Notes

## Previous Story Insights
Depends on Story 2.1 completion - requires working dual platform account linking and stored Account records with either mono_account_id (for banks) or mtn_reference_id (for mobile money) and institution_name.

## Data Models
Transaction model must accommodate Mono synced data: [Source: architecture.md#Data Models → Transactions]
```typescript
export interface Transaction {
  id: string; // UUID
  user_id: string; // UUID
  account_id: string | null; // UUID - Required for synced transactions
  category_id: string; // UUID - Will default to "Uncategorized" 
  amount: number;
  type: 'income' | 'expense';
  description: string; // From Mono API transaction description OR MTN MoMo transaction description
  transaction_date: string; // ISO 8601 from Mono API data OR MTN MoMo API data
  is_synced: boolean; // Set to true for all synced transactions
  institution_name: string; // e.g., 'GCB Bank' for Mono OR 'MTN Mobile Money' for MTN MoMo
  // Platform-specific identifiers
  mono_transaction_id?: string; // For bank transactions via Mono
  mtn_reference_id?: string; // For MTN MoMo transactions
}
```

## API Specifications
Backend endpoints needed: [Source: architecture.md#API Specification]
- POST /accounts/{id}/sync - Trigger initial sync for specific account (detects platform type automatically)
- Internal Mono API calls: getAccountInformation() and getAccountTransactions() for bank accounts
- Internal MTN MoMo API calls: Collections API endpoints for transaction history and balance
- Response includes transaction array and account details from appropriate platform API

## External API Integration
**Mono API (Banks):**
- Documentation: https://docs.mono.co/
- Methods: getAccountInformation() and getAccountTransactions() for bank accounts
- Parameters: start/end dates for 30-day window, pagination support
- Authentication via MONO_SECRET_KEY in backend with mono-node package

**MTN MoMo API (Mobile Money):**
- Documentation: https://momodeveloper.mtn.com/
- Collections API for transaction history and account balance
- Authentication: Primary/Secondary keys → API User → API Key → Access Token flow
- Environment variables: MTN_MOMO_PRIMARY_KEY, MTN_MOMO_SECONDARY_KEY

## Component Specifications
SyncProgressModal component structure: [Source: architecture.md#Frontend Architecture → Component Architecture]
- Modal overlay using Gluestack UI Modal component
- Progress indicator (spinner or progress bar)
- Status text display
- Success/error state handling
- Dismiss functionality

## File Locations
Backend files: [Source: architecture.md#Unified Project Structure → Backend Repository]
- Edge Function: supabase/functions/accounts-sync/
- Shared utilities: supabase/functions/shared/mono-client.ts, supabase/functions/shared/mtn-client.ts
- Database operations: supabase/functions/shared/transaction-repository.ts
- Platform abstraction: supabase/functions/shared/account-aggregator.ts

Frontend files: [Source: architecture.md#Unified Project Structure → Frontend Repository]  
- Component: src/components/features/accounts/SyncProgressModal.tsx
- Services: src/services/monoSyncService.ts, src/services/mtnMomoSyncService.ts, src/services/accountAggregator.ts
- Store updates: src/stores/transactionStore.ts, src/stores/accountStore.ts

## Security Requirements
- All API calls require valid JWT authentication [Source: architecture.md#Security Requirements → Authentication Security]
- Transaction data stored with user_id association for RLS [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- Input validation on both Mono API and MTN MoMo API response data [Source: architecture.md#Security Requirements → Backend Security]
- Secure handling of potentially sensitive transaction descriptions from both platforms
- Platform-specific token management (Mono Account IDs and MTN MoMo Access Tokens)

## State Management
Transaction store updates needed: [Source: architecture.md#Frontend Architecture → State Management Architecture]
- Add synced transactions from both platforms to transactionStore
- Update account balance if provided by Mono API (banks) or MTN MoMo API (mobile money)
- Trigger UI refresh for dashboard and transaction lists with platform-specific indicators
- Handle loading states during sync process with platform-specific messaging

## Testing Requirements
Test file locations: [Source: architecture.md#Testing Strategy → Test Organization]
- Backend: Tests in supabase/functions/accounts-sync/ directory
- Frontend: SyncProgressModal.test.tsx co-located with component
- Integration: Full sync workflow testing with mock Mono API and MTN MoMo API responses
- Error handling: Test platform-specific network failures, invalid data, rate limiting for both APIs

## Technical Constraints
- 30-day transaction window as specified in AC for both platforms [Source: Epic requirements]
- Deno Test Runner for Edge Function testing [Source: architecture.md#Tech Stack → Backend Testing]
- Handle large transaction volumes efficiently (batch processing) for both Mono and MTN MoMo
- Performance target: <200ms API response for sync trigger regardless of platform [Source: architecture.md#Security and Performance → Performance Optimization]
- Environment variables: MONO_SECRET_KEY, MONO_PUBLIC_KEY, MTN_MOMO_PRIMARY_KEY, MTN_MOMO_SECONDARY_KEY

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |
| 2025-08-21 | 2.0     | Updated for hybrid Mono + MTN MoMo integration approach | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Story significantly updated from single platform (MTN MoMo only) to dual platform approach
- Original implementation was MTN MoMo API only
- Current version requires both Mono API integration for banks AND MTN MoMo Collections API for mobile money
- Previous completion status no longer valid due to fundamental architectural changes

### Completion Notes List

**✅ COMPLETED**: Story 2.2 dual platform data sync implementation completed successfully.

**Implementation Summary**:
- ✅ Dual platform Edge Function: Updated `supabase/functions/accounts-sync/index.ts` with complete POST endpoint supporting both Mono bank accounts and MTN MoMo mobile money syncing
- ✅ Platform Clients: Built `supabase/functions/shared/mono-client.ts` for Mono API integration and updated existing `mtn-client.ts` usage
- ✅ Backend Account Aggregator: Created `supabase/functions/shared/account-aggregator.ts` for unified sync orchestration
- ✅ Frontend Services: Implemented `monoSyncService.ts` and enhanced `accountAggregator.ts` with dual platform sync methods
- ✅ UI Components: Updated `SyncProgressModal.tsx` with platform-specific branding and messaging
- ✅ Data Models: Enhanced Transaction model with dual platform identifiers (`mono_transaction_id`, `mtn_reference_id`)
- ✅ Comprehensive Testing: Created test suites for all new components and dual platform functionality

**Key Features Implemented**:
- ✅ Platform detection and routing based on account type (bank vs mobile_money)
- ✅ Dual platform transaction syncing with 30-day date filtering
- ✅ Platform-specific progress indicators and user feedback
- ✅ Unified sync API with consistent response format
- ✅ Error handling and retry mechanisms for both platforms
- ✅ Account validation and sync history tracking
- ✅ Automatic transaction categorization for both platforms

**Code Quality**: 
- ✅ ESLint: Clean code with only acceptable console statements for logging
- ✅ TypeScript: All type errors resolved with proper dual platform typing
- ✅ Component Integration: All components follow existing codebase patterns and conventions
- ✅ Security: JWT authentication, RLS policies, and secure token management

**Testing Status**: 
- ✅ Unit tests: Complete coverage for MonoSyncService, AccountAggregator sync methods
- ✅ Component tests: SyncProgressModal dual platform support
- ✅ Integration tests: Account routing and platform-specific sync flows
- ✅ Error scenario tests: Network failures, invalid accounts, platform-specific errors

**Completed Files**:
- ✅ `supabase/functions/shared/mono-client.ts` - Mono API integration client
- ✅ `supabase/functions/shared/account-aggregator.ts` - Backend unified sync orchestration
- ✅ `supabase/functions/accounts-sync/index.ts` - Enhanced Edge Function with dual platform support
- ✅ `src/services/monoSyncService.ts` - Frontend Mono sync service
- ✅ `src/services/accountAggregator.ts` - Enhanced with sync methods for both platforms
- ✅ `src/components/features/accounts/SyncProgressModal.tsx` - Platform-specific UI updates
- ✅ `src/types/models.ts` - Updated Transaction model with dual platform identifiers
- ✅ `__tests__/monoSyncService.test.ts` - Comprehensive Mono sync tests
- ✅ `__tests__/accountAggregatorSync.test.ts` - Dual platform routing tests
- ✅ `__tests__/SyncProgressModalDualPlatform.test.tsx` - Platform-specific UI tests

### File List

**Backend/Edge Functions:**
- `supabase/functions/accounts-sync/index.ts` - Main sync endpoint with authentication, validation, and dual platform transaction processing
- `supabase/functions/shared/mono-client.ts` - Mono API client using mono-node package for bank account support
- `supabase/functions/shared/mtn-client.ts` - MTN MoMo API client for mobile money Collections API integration
- `supabase/functions/shared/account-aggregator.ts` - Platform abstraction layer for unified sync handling

**Frontend Components:**
- `src/components/features/accounts/SyncProgressModal.tsx` - React Native modal with progress tracking and platform-specific branding

**Services:**
- `src/services/monoSyncService.ts` - Frontend service for calling sync Edge Function for bank accounts with progress callbacks
- `src/services/mtnMomoSyncService.ts` - Frontend service for MTN MoMo account sync with progress callbacks
- `src/services/accountAggregator.ts` - Unified service layer for both platforms

**Store Updates:**
- `src/stores/accountStore.ts` - Added `syncAccountWithProgress` method supporting both Mono and MTN MoMo account types

**Testing:**
- `__tests__/accounts-sync-edge-function.test.ts` - Integration tests for Edge Function logic across both platforms
- `__tests__/monoSyncService.test.ts` - Unit tests for Mono sync service
- `__tests__/mtnSyncService.test.ts` - Unit tests for MTN MoMo sync service
- `__tests__/SyncProgressModal.test.tsx` - Component tests for progress modal UI with platform variations

**Configuration:**
- `.eslintrc.js` - Updated with Deno globals for Edge Function environment
- Environment variables: MONO_SECRET_KEY, MONO_PUBLIC_KEY, MTN_MOMO_PRIMARY_KEY, MTN_MOMO_SECONDARY_KEY

---

## QA Results

Pending QA review.
