# Status

Draft

---

# Story

**As a** user,
**I want** the app to import my recent transaction history after I link a new account,
**so that** I have an immediate and useful overview of my spending.

---

# Acceptance Criteria

1. Immediately after an account is successfully linked, the app automatically fetches the last 30 days of transactions.
2. Fetched transactions are stored securely in the database and associated with the correct user and account.
3. The sync process displays clear feedback to the user (e.g., a loading indicator followed by a success message).
4. The process gracefully handles and reports any API errors during the sync.

Source: `docs/prd/epic-2-automated-account-integration.md#story-22-initial-transaction-sync`

---

# Tasks / Subtasks

- [ ] Transaction Fetching Service (AC: 1)
  - [ ] Create GET /accounts/{id}/transactions Mono API integration [Source: architecture.md#External APIs → Mono API]
  - [ ] Implement 30-day date filtering in transaction fetch request
  - [ ] Create POST /accounts/{id}/sync Edge Function to trigger initial sync [Source: architecture.md#API Specification]

- [ ] Transaction Storage (AC: 2) 
  - [ ] Map Mono transaction format to internal Transaction model [Source: architecture.md#Data Models → Transactions]
  - [ ] Store transactions with is_synced=true and proper account_id association [Source: architecture.md#Data Models → Transactions]
  - [ ] Implement user_id association via JWT authentication [Source: architecture.md#Security Requirements → Authentication Security]
  - [ ] Handle duplicate transaction detection (prevent re-sync of same transactions)

- [ ] User Feedback Interface (AC: 3)
  - [ ] Create SyncProgressModal component with loading indicator [Source: architecture.md#Frontend Architecture → Component Architecture]
  - [ ] Show sync status: "Fetching transactions...", "Storing data...", "Complete!" 
  - [ ] Display transaction count when sync completes (e.g., "Imported 45 transactions")
  - [ ] Auto-close modal after success message or allow manual dismiss

- [ ] Error Handling (AC: 4)
  - [ ] Implement standardized error response format [Source: architecture.md#Error Handling Strategy → Error Response Format]
  - [ ] Handle Mono API rate limits and network errors gracefully
  - [ ] Show user-friendly error messages for common failure scenarios
  - [ ] Log detailed errors to debug log for troubleshooting [Source: architecture.md#Development Workflow → devDebugLog]
  - [ ] Provide retry mechanism for failed sync attempts

- [ ] Backend Integration
  - [ ] Extend Account Aggregation Service from Story 2.1 [Source: architecture.md#Components → Account Aggregation Service]
  - [ ] Implement transaction transformation logic (Mono format → internal format)
  - [ ] Add transaction batch insertion for performance
  - [ ] Ensure RLS policies allow user to access only their synced transactions [Source: architecture.md#Backend Architecture → Authentication and Authorization]

- [ ] Testing
  - [ ] Unit tests: Transaction format mapping and deduplication logic [Source: architecture.md#Testing Strategy → Backend Testing]
  - [ ] Integration tests: End-to-end sync flow with mock Mono API responses [Source: architecture.md#Testing Strategy → Integration Tests]  
  - [ ] Component tests: SyncProgressModal rendering and state transitions [Source: architecture.md#Testing Strategy → Frontend Testing]
  - [ ] Error scenario tests: Network failures, API errors, invalid data handling

---

# Dev Notes

## Previous Story Insights
Depends on Story 2.1 completion - requires working account linking and stored Account records with aggregator_account_id.

## Data Models
Transaction model must accommodate synced data: [Source: architecture.md#Data Models → Transactions]
```typescript
export interface Transaction {
  id: string; // UUID
  user_id: string; // UUID
  account_id: string | null; // UUID - Required for synced transactions
  category_id: string; // UUID - Will default to "Uncategorized" 
  amount: number;
  type: 'income' | 'expense';
  description: string; // From Mono transaction description
  transaction_date: string; // ISO 8601 from Mono data
  is_synced: boolean; // Set to true for all synced transactions
}
```

## API Specifications
Backend endpoints needed: [Source: architecture.md#API Specification]
- POST /accounts/{id}/sync - Trigger initial sync for specific account
- Internal Mono API call: GET /accounts/{id}/transactions with date range parameters
- Response includes transaction array with Mono's data structure

## External API Integration
Mono API transaction sync: [Source: architecture.md#External APIs → Mono API]
- Documentation: https://docs.mono.co/
- GET /accounts/{id}/transactions endpoint
- Query parameters: start_date, end_date for 30-day window
- Response includes: amount, description, date, type, reference
- Authentication via MONO_SECRET_KEY in backend

## Component Specifications
SyncProgressModal component structure: [Source: architecture.md#Frontend Architecture → Component Architecture]
- Modal overlay using Gluestack UI Modal component
- Progress indicator (spinner or progress bar)
- Status text display
- Success/error state handling
- Dismiss functionality

## File Locations
Backend files: [Source: architecture.md#Unified Project Structure → Backend Repository]
- Edge Function: supabase/functions/accounts-sync/
- Shared utilities: supabase/functions/shared/mono-client.ts
- Database operations: supabase/functions/shared/transaction-repository.ts

Frontend files: [Source: architecture.md#Unified Project Structure → Frontend Repository]  
- Component: src/components/features/accounts/SyncProgressModal.tsx
- Service: src/services/syncService.ts
- Store updates: src/stores/transactionStore.ts, src/stores/accountStore.ts

## Security Requirements
- All API calls require valid JWT authentication [Source: architecture.md#Security Requirements → Authentication Security]
- Transaction data stored with user_id association for RLS [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- Input validation on all Mono API response data [Source: architecture.md#Security Requirements → Backend Security]
- Secure handling of potentially sensitive transaction descriptions

## State Management
Transaction store updates needed: [Source: architecture.md#Frontend Architecture → State Management Architecture]
- Add synced transactions to transactionStore
- Update account balance if provided by Mono API
- Trigger UI refresh for dashboard and transaction lists
- Handle loading states during sync process

## Testing Requirements
Test file locations: [Source: architecture.md#Testing Strategy → Test Organization]
- Backend: Tests in supabase/functions/accounts-sync/ directory
- Frontend: SyncProgressModal.test.tsx co-located with component
- Integration: Full sync workflow testing with mock API responses
- Error handling: Test network failures, invalid data, rate limiting

## Technical Constraints
- 30-day transaction window as specified in AC [Source: Epic requirements]
- Deno Test Runner for Edge Function testing [Source: architecture.md#Tech Stack → Backend Testing]
- Handle large transaction volumes efficiently (batch processing)
- Performance target: <200ms API response for sync trigger [Source: architecture.md#Security and Performance → Performance Optimization]

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## QA Results

Pending QA review.
