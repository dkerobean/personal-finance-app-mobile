# Status

Draft

---

# Story

**As a** user,
**I want** to securely connect my bank and mobile money accounts to the app,
**so that** my transactions can be automatically tracked.

---

# Acceptance Criteria

1. An "Add Account" option is available within the app.
2. Tapping this option launches the third-party aggregator's (e.g., Mono) secure connection widget.
3. The user can successfully authenticate with their financial institution via the widget.
4. Upon a successful link, the app securely stores the necessary token to access the account's data.
5. The newly linked account appears in a list of "Linked Accounts" in the app's settings.
6. The user has the ability to unlink an existing account.

Source: `docs/prd/epic-2-automated-account-integration.md#story-21-secure-account-linking`

---

# Tasks / Subtasks

- [ ] Add Account UI (AC: 1)
  - [ ] Create "Add Account" button in settings or main dashboard [Source: architecture.md#Frontend Architecture]
  - [ ] Create AddAccountScreen component using Gluestack UI

- [ ] Mono Widget Integration (AC: 2, 3)
  - [ ] Install and configure Mono React Native SDK
  - [ ] Implement MonoWidget component with proper error handling [Source: architecture.md#External APIs → Mono API]
  - [ ] Handle authentication success/failure callbacks

- [ ] Backend Account Linking (AC: 4)
  - [ ] Create POST /accounts/link Edge Function [Source: architecture.md#API Specification → /accounts/link]
  - [ ] Exchange Mono code for account_id via Mono API [Source: architecture.md#Core Workflows]
  - [ ] Store Account model in database with aggregator_account_id [Source: architecture.md#Data Models → Accounts]

- [ ] Linked Accounts Display (AC: 5)
  - [ ] Create LinkedAccountsList component showing account_name and account_type [Source: architecture.md#Data Models → Accounts]
  - [ ] Fetch user's accounts via GET /accounts API
  - [ ] Display in app settings with proper Gluestack UI styling

- [ ] Account Unlinking (AC: 6)
  - [ ] Add unlink button to LinkedAccountsList items
  - [ ] Implement DELETE /accounts/{id} Edge Function [Source: architecture.md#API Specification]
  - [ ] Handle unlinking confirmation dialog

- [ ] Security & Error Handling
  - [ ] Implement JWT authentication for all API calls [Source: architecture.md#Security Requirements → Authentication Security]
  - [ ] Store tokens securely using expo-secure-store [Source: architecture.md#Security Requirements → Frontend Security]
  - [ ] Add proper error handling and user feedback [Source: architecture.md#Error Handling Strategy]

- [ ] Testing
  - [ ] Unit tests: Account linking service functions [Source: architecture.md#Testing Strategy → Frontend Testing]
  - [ ] Component tests: AddAccountScreen, LinkedAccountsList rendering [Source: architecture.md#Testing Strategy → Test Organization]
  - [ ] Integration tests: End-to-end account linking flow [Source: architecture.md#Testing Strategy → Integration Tests]

---

# Dev Notes

## Previous Story Insights
No specific guidance found in previous stories - this is the first backend integration story.

## Data Models
Account model structure from architecture: [Source: architecture.md#Data Models → Accounts]
```typescript
export interface Account {
  id: string; // UUID
  user_id: string; // UUID
  account_name: string;
  account_type: 'bank' | 'mobile_money';
  balance: number;
  aggregator_account_id: string;
  last_synced_at: string; // ISO 8601 Timestamp
}
```

## API Specifications
- POST /accounts/link endpoint for linking new accounts [Source: architecture.md#API Specification → /accounts/link]
- All endpoints require valid JWT from Supabase Auth [Source: architecture.md#API Specification]
- Backend API hosted at: https://{your-supabase-project-ref}.supabase.co/functions/v1 [Source: architecture.md#API Specification]

## External API Integration
Mono API integration details: [Source: architecture.md#External APIs → Mono API]
- Documentation: https://docs.mono.co/
- Backend authentication: Secret Key (MONO_SECRET_KEY environment variable)
- Key endpoints: POST /account/auth, GET /accounts/{id}/transactions
- Frontend: React Native widget for user authentication

## Component Specifications
- Use Gluestack UI for all UI components [Source: architecture.md#Tech Stack → UI Component Library]
- Components location: src/components/features/accounts/ [Source: architecture.md#Frontend Architecture → Component Architecture]
- Follow functional component pattern with TypeScript [Source: architecture.md#Frontend Architecture → Component Architecture]

## File Locations
Frontend structure: [Source: architecture.md#Unified Project Structure → Frontend Repository]
- Components: src/components/features/accounts/
- Services: src/services/accountService.ts
- API client: src/services/apiClient.ts [Source: architecture.md#Frontend Architecture → Frontend Services Layer]

Backend structure: [Source: architecture.md#Unified Project Structure → Backend Repository]
- Edge Functions: supabase/functions/accounts-link/
- Shared utilities: supabase/functions/shared/

## Security Requirements
- JWT authentication required for all API calls [Source: architecture.md#Security Requirements → Authentication Security]
- Store sensitive tokens using expo-secure-store [Source: architecture.md#Security Requirements → Frontend Security]
- Row Level Security (RLS) ensures users only access their data [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- Input validation required on server before processing [Source: architecture.md#Security Requirements → Backend Security]

## State Management
- Use Zustand for global state management [Source: architecture.md#Tech Stack → State Management]
- Create separate accountStore for account-related state [Source: architecture.md#Frontend Architecture → State Management Architecture]
- Store pattern: state, actions, async functions for fetching data [Source: architecture.md#Frontend Architecture → State Management Architecture]

## Testing Requirements
Co-located test files with source code: [Source: architecture.md#Testing Strategy → Test Organization]
- Frontend: Component.test.tsx next to Component.tsx
- Backend: Tests within Edge Function directories
- Testing frameworks: Jest & React Native Testing Library for frontend [Source: architecture.md#Tech Stack → Frontend Testing]
- Backend: Deno Test Runner for Edge Functions [Source: architecture.md#Tech Stack → Backend Testing]

## Technical Constraints
- TypeScript required throughout [Source: architecture.md#Tech Stack → Frontend/Backend Language]
- React Native (Expo) ~50.0.0 for frontend [Source: architecture.md#Tech Stack → Frontend Framework]
- Supabase Edge Functions for backend [Source: architecture.md#Tech Stack → Backend Platform]
- Environment variables: EXPO_PUBLIC_SUPABASE_URL, EXPO_PUBLIC_SUPABASE_ANON_KEY [Source: architecture.md#Development Workflow → Environment Configuration]

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## QA Results

Pending QA review.

