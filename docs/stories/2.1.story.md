# Status

Draft

---

# Story

**As a** user,
**I want** to securely connect my MTN Mobile Money account to the app,
**so that** my mobile money transactions can be automatically tracked.

---

# Acceptance Criteria

1. An "Add MTN MoMo Account" option is available within the app.
2. Tapping this option launches the official MTN Mobile Money API authentication flow.
3. The user can successfully authenticate with their MTN Mobile Money account via the official MTN MoMo authentication process.
4. Upon a successful link, the app securely stores the necessary token to access the MTN MoMo account's data.
5. The newly linked MTN MoMo account appears in a list of "Linked Accounts" in the app's settings.
6. The user has the ability to unlink their MTN MoMo account.

Source: `docs/prd/epic-2-automated-account-integration.md#story-21-secure-mtn-momo-account-linking`

---

# Tasks / Subtasks

- [ ] Add MTN MoMo Account UI (AC: 1)
  - [ ] Create "Add MTN MoMo Account" button in settings or main dashboard [Source: architecture.md#Frontend Architecture]
  - [ ] Create AddMTNAccountScreen component using Gluestack UI

- [ ] MTN MoMo API Integration (AC: 2, 3)
  - [ ] Install and configure MTN Mobile Money API SDK
  - [ ] Implement MTN MoMo authentication component with proper error handling
  - [ ] Handle MTN MoMo authentication success/failure callbacks

- [ ] Backend MTN MoMo Account Linking (AC: 4)
  - [ ] Create POST /accounts/link Edge Function [Source: architecture.md#API Specification → /accounts/link]
  - [ ] Exchange MTN MoMo auth token for account access via MTN MoMo API
  - [ ] Store Account model in database with mtn_account_id and account_type='mobile_money' [Source: architecture.md#Data Models → Accounts]

- [ ] Linked MTN MoMo Account Display (AC: 5)
  - [ ] Create LinkedAccountsList component showing MTN MoMo account_name and account_type='mobile_money' [Source: architecture.md#Data Models → Accounts]
  - [ ] Fetch user's MTN MoMo account via GET /accounts API
  - [ ] Display in app settings with proper Gluestack UI styling and MTN MoMo branding

- [ ] MTN MoMo Account Unlinking (AC: 6)
  - [ ] Add unlink button to LinkedAccountsList for MTN MoMo account
  - [ ] Implement DELETE /accounts/{id} Edge Function [Source: architecture.md#API Specification]
  - [ ] Handle MTN MoMo unlinking confirmation dialog

- [ ] Security & Error Handling
  - [ ] Implement JWT authentication for all API calls [Source: architecture.md#Security Requirements → Authentication Security]
  - [ ] Store tokens securely using expo-secure-store [Source: architecture.md#Security Requirements → Frontend Security]
  - [ ] Add proper error handling and user feedback [Source: architecture.md#Error Handling Strategy]

- [ ] Testing
  - [ ] Unit tests: MTN MoMo account linking service functions [Source: architecture.md#Testing Strategy → Frontend Testing]
  - [ ] Component tests: AddMTNAccountScreen, LinkedAccountsList rendering [Source: architecture.md#Testing Strategy → Test Organization]
  - [ ] Integration tests: End-to-end MTN MoMo account linking flow [Source: architecture.md#Testing Strategy → Integration Tests]

---

# Dev Notes

## Previous Story Insights
No specific guidance found in previous stories - this is the first MTN MoMo backend integration story.

## Data Models
Account model structure from architecture: [Source: architecture.md#Data Models → Accounts]
```typescript
export interface Account {
  id: string; // UUID
  user_id: string; // UUID
  account_name: string;
  account_type: 'bank' | 'mobile_money';
  balance: number;
  mtn_account_id: string; // MTN MoMo account identifier
  last_synced_at: string; // ISO 8601 Timestamp
}
```

## API Specifications
- POST /accounts/link endpoint for linking new accounts [Source: architecture.md#API Specification → /accounts/link]
- All endpoints require valid JWT from Supabase Auth [Source: architecture.md#API Specification]
- Backend API hosted at: https://{your-supabase-project-ref}.supabase.co/functions/v1 [Source: architecture.md#API Specification]

## External API Integration
MTN Mobile Money API integration details:
- Documentation: https://developer.mtn.com/
- Backend authentication: API Key and Secret (MTN_API_KEY, MTN_API_SECRET environment variables)
- Key endpoints: POST /oauth/token, GET /v1_0/account/balance, GET /v1_0/account/transactions
- Frontend: Official MTN MoMo SDK for user authentication

## Component Specifications
- Use Gluestack UI for all UI components [Source: architecture.md#Tech Stack → UI Component Library]
- Components location: src/components/features/accounts/ [Source: architecture.md#Frontend Architecture → Component Architecture]
- Follow functional component pattern with TypeScript [Source: architecture.md#Frontend Architecture → Component Architecture]
- Focus on MTN MoMo branding and mobile money user experience patterns

## File Locations
Frontend structure: [Source: architecture.md#Unified Project Structure → Frontend Repository]
- Components: src/components/features/accounts/
- Services: src/services/mtnMomoService.ts
- API client: src/services/apiClient.ts [Source: architecture.md#Frontend Architecture → Frontend Services Layer]

Backend structure: [Source: architecture.md#Unified Project Structure → Backend Repository]
- Edge Functions: supabase/functions/accounts-link/
- Shared utilities: supabase/functions/shared/mtn-client.ts

## Security Requirements
- JWT authentication required for all API calls [Source: architecture.md#Security Requirements → Authentication Security]
- Store sensitive tokens using expo-secure-store [Source: architecture.md#Security Requirements → Frontend Security]
- Row Level Security (RLS) ensures users only access their data [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- Input validation required on server before processing [Source: architecture.md#Security Requirements → Backend Security]

## State Management
- Use Zustand for global state management [Source: architecture.md#Tech Stack → State Management]
- Create separate accountStore for account-related state [Source: architecture.md#Frontend Architecture → State Management Architecture]
- Store pattern: state, actions, async functions for fetching data [Source: architecture.md#Frontend Architecture → State Management Architecture]

## Testing Requirements
Co-located test files with source code: [Source: architecture.md#Testing Strategy → Test Organization]
- Frontend: Component.test.tsx next to Component.tsx
- Backend: Tests within Edge Function directories
- Testing frameworks: Jest & React Native Testing Library for frontend [Source: architecture.md#Tech Stack → Frontend Testing]
- Backend: Deno Test Runner for Edge Functions [Source: architecture.md#Tech Stack → Backend Testing]

## Technical Constraints
- TypeScript required throughout [Source: architecture.md#Tech Stack → Frontend/Backend Language]
- React Native (Expo) ~50.0.0 for frontend [Source: architecture.md#Tech Stack → Frontend Framework]
- Supabase Edge Functions for backend [Source: architecture.md#Tech Stack → Backend Platform]
- Environment variables: EXPO_PUBLIC_SUPABASE_URL, EXPO_PUBLIC_SUPABASE_ANON_KEY, MTN_API_KEY, MTN_API_SECRET [Source: architecture.md#Development Workflow → Environment Configuration]

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## QA Results

Pending QA review.

