# Status

Ready for Review

---

# Story

**As a** user,
**I want** to easily see how much I've spent compared to my budget for each category,
**so that** I know if I'm staying on track.

---

# Acceptance Criteria

1. The "Budgets" screen displays each budget along with the total amount spent in that category for the current month.
2. A clear visual indicator, such as a progress bar, shows what percentage of the budget has been used.
3. The display updates automatically when new transactions are added or categorized.
4. Tapping a budget item navigates to a filtered list of all transactions in that category for the current month.

Source: `docs/prd/epic-3-budgeting-reporting-alerts.md#story-32-budget-tracking--display`

---

# Tasks / Subtasks

- [x] Budget Spending Calculation (AC: 1)
  - [x] Create GET /budgets/tracking endpoint returning budgets with spending totals [Source: architecture.md#Components → Budgeting Service]
  - [x] Calculate monthly spending per category using transaction aggregation [Source: architecture.md#Data Models → Transactions]
  - [x] Handle both manual and synced transactions in spending calculations (if Epic 2 implemented)
  - [x] Filter transactions by month and category for accurate totals
  - [x] Return budget vs. actual spending data structure for UI consumption

- [x] Visual Progress Indicators (AC: 2)
  - [x] Create BudgetProgressCard component with progress bar using Gluestack UI [Source: architecture.md#Tech Stack → UI Component Library]
  - [x] Calculate and display spending percentage (spent/budget * 100)
  - [x] Implement color-coded progress bars: green (<75%), yellow (75-90%), red (>90%)
  - [x] Show remaining budget amount and days left in current month
  - [x] Handle edge cases: over-budget, zero budget, no spending

- [x] Real-time Budget Updates (AC: 3)
  - [x] Update budgetStore when transactions are added/edited/deleted [Source: architecture.md#Frontend Architecture → State Management Architecture]
  - [x] Implement budget spending recalculation triggers
  - [x] Subscribe to transaction store changes for automatic UI refresh
  - [x] Use optimistic updates for immediate feedback when transactions change
  - [x] Handle concurrent updates and data synchronization

- [x] Budget Detail Navigation (AC: 4)
  - [x] Create BudgetDetailScreen showing filtered transactions [Source: architecture.md#Frontend Architecture → Component Architecture]
  - [x] Implement navigation: `app/(app)/budgets/[id]/transactions.tsx`
  - [x] Filter transactions by category and current month
  - [x] Reuse TransactionsList component from Epic 1 with filtering [Source: architecture.md#Frontend Architecture → Component Architecture]
  - [x] Add breadcrumb navigation showing budget context

- [x] Enhanced Budget Display
  - [x] Update BudgetsList component from Story 3.1 to show tracking data
  - [x] Display budget name, limit, spent amount, and remaining budget
  - [x] Add visual cues for budget status (on track, warning, over budget)
  - [x] Implement sorting options (by spending percentage, remaining amount, category name)
  - [x] Add quick actions (edit budget, view transactions) on list items

- [x] Backend Aggregation Logic
  - [x] Create budget tracking repository methods for spending calculations
  - [x] Implement efficient SQL queries with proper indexing [Source: architecture.md#Security and Performance → Performance Optimization]
  - [x] Add caching for frequently accessed budget calculations
  - [x] Handle timezone considerations for month calculations
  - [x] Optimize for performance with large transaction datasets

- [x] Data Integration Layer
  - [x] Create BudgetWithSpending interface extending Budget model [Source: architecture.md#Data Models → Budgets]
  - [x] Implement transaction aggregation service
  - [x] Add month-based filtering utilities
  - [x] Create budget analytics selectors in store
  - [x] Handle decimal precision for currency calculations

- [x] State Management Enhancements
  - [x] Extend budgetStore with spending tracking capabilities [Source: architecture.md#Frontend Architecture → State Management Architecture]
  - [x] Add budget analytics actions and selectors
  - [x] Implement budget refresh triggers on transaction changes
  - [x] Cache spending calculations to avoid unnecessary API calls
  - [x] Handle loading states for spending calculations

- [x] Testing
  - [x] Unit tests: Spending calculation accuracy, percentage calculations [Source: architecture.md#Testing Strategy → Frontend Testing]
  - [x] Component tests: BudgetProgressCard rendering, color coding, progress states
  - [x] Integration tests: Real-time updates when transactions change
  - [x] Performance tests: Budget calculations with large transaction datasets
  - [x] Backend tests: Aggregation queries, filtering accuracy [Source: architecture.md#Testing Strategy → Backend Testing]

---

# Dev Notes

## Previous Story Insights
Builds directly on Story 3.1:
- Requires existing budget creation and management functionality
- Integrates with Epic 1 transaction system (Story 1.4) for spending calculations
- If Epic 2 implemented, must include synced transactions in calculations

## Data Models
Extended budget interface with spending data: [Source: architecture.md#Data Models → Budgets]
```typescript
export interface BudgetWithSpending extends Budget {
  spent: number; // Total spent in category for the month
  percentage: number; // (spent / amount) * 100
  remaining: number; // amount - spent
  status: 'on_track' | 'warning' | 'over_budget';
  transaction_count: number; // Number of transactions in category/month
}
```

Transaction aggregation for spending calculation: [Source: architecture.md#Data Models → Transactions]
- Filter by category_id and transaction_date within budget month
- Sum amounts where type='expense' for the category
- Include both manual (is_synced=false) and automated transactions (is_synced=true) if applicable

## API Specifications
Enhanced budget endpoints: [Source: architecture.md#API Specification]
- GET /budgets/tracking: Returns budgets with spending calculations for current month
- GET /budgets/{id}/transactions: Returns filtered transactions for budget detail view
- Query parameters: month (YYYY-MM format) for historical budget tracking
- Response includes aggregated spending data and transaction counts

## Component Specifications
Budget tracking UI components: [Source: architecture.md#Frontend Architecture → Component Architecture]
- **BudgetProgressCard**: Visual budget progress with bar, percentages, and status colors
- **BudgetDetailScreen**: Full-screen view of budget with transaction list
- **BudgetStatusBadge**: Color-coded status indicator (on track/warning/over budget)
- **SpendingChart**: Optional visual spending breakdown (pie chart or bar chart)

## File Locations
Budget tracking implementation: [Source: architecture.md#Unified Project Structure → Frontend Repository]
- Update: `app/(app)/budgets/index.tsx` (main budgets screen)
- New: `app/(app)/budgets/[id]/transactions.tsx` (budget detail/transactions)
- New: `src/components/budgets/BudgetProgressCard.tsx`
- New: `src/components/budgets/BudgetDetailScreen.tsx`
- Update: `src/stores/budgetStore.ts` (add tracking capabilities)
- New: `src/services/budgetTrackingService.ts`

Backend tracking services: [Source: architecture.md#Unified Project Structure → Backend Repository]
- New: `supabase/functions/budget-tracking/`
- Update: Budgeting Service to include spending calculations [Source: architecture.md#Components → Budgeting Service]

## Security Requirements
Budget tracking data access: [Source: architecture.md#Security Requirements]
- All budget tracking data protected by RLS policies [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- JWT authentication required for all tracking endpoints [Source: architecture.md#Security Requirements → Authentication Security]
- Validate user owns budgets and transactions before aggregation
- Prevent data leakage between users in aggregated queries

## State Management
Enhanced budget store for tracking: [Source: architecture.md#Frontend Architecture → State Management Architecture]
```typescript
interface BudgetTrackingStore extends BudgetStore {
  // Tracking-specific state
  budgetsWithSpending: BudgetWithSpending[];
  lastUpdated: string;
  
  // Tracking actions
  fetchBudgetTracking: (month?: string) => Promise<void>;
  refreshBudgetSpending: () => Promise<void>;
  getBudgetProgress: (budgetId: string) => BudgetWithSpending | undefined;
  
  // Real-time update handlers
  onTransactionChanged: (transaction: Transaction) => void;
}
```

## Business Logic
Budget tracking calculations:
- Spending percentage: (totalSpent / budgetAmount) * 100
- Status determination: <75% = on_track, 75-90% = warning, >90% = over_budget
- Remaining budget: budgetAmount - totalSpent (can be negative)
- Month filtering: Use transaction_date within budget month boundaries
- Currency precision: Handle decimal calculations appropriately

## Performance Considerations
Optimization strategies: [Source: architecture.md#Security and Performance → Performance Optimization]
- Cache aggregated spending calculations
- Use database indexes on category_id and transaction_date
- Implement pagination for large transaction lists in detail view
- Debounce real-time updates to avoid excessive API calls
- Pre-calculate common aggregations (monthly totals, category sums)

## Testing Requirements
Comprehensive tracking validation: [Source: architecture.md#Testing Strategy]
- Accuracy testing: Verify spending calculations match transaction sums
- Real-time update testing: Ensure UI updates when transactions change
- Edge case testing: Zero budgets, over-budget scenarios, no transactions
- Performance testing: Large transaction datasets, concurrent updates
- Visual testing: Progress bar accuracy, color coding correctness

## Technical Constraints
User experience and performance:
- Real-time updates should be smooth and performant
- Progress calculations must be accurate to prevent user confusion  
- Visual indicators should be intuitive and accessible
- Support for different currency formats and decimal precision
- Maintain responsive design across different screen sizes

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- BudgetProgressCard component implementation
- Budget tracking API endpoint development
- Store state management enhancements
- Real-time update subscription implementation

### Completion Notes List
- ✅ Successfully implemented all acceptance criteria
- ✅ Backend tracking endpoint with efficient SQL aggregation
- ✅ Visual progress indicators with color-coded status
- ✅ Real-time updates when transactions change
- ✅ Navigation to budget detail screen with filtered transactions
- ✅ Enhanced BudgetsList component with progress tracking
- ✅ Comprehensive test suite for all components
- ✅ Type-safe interfaces and error handling

### File List
- **Created**: `supabase/functions/budget-tracking/index.ts` - Backend endpoint for budget tracking
- **Created**: `src/components/budgets/BudgetProgressCard.tsx` - Visual progress component
- **Created**: `app/(app)/budgets/[id]/transactions.tsx` - Budget detail screen
- **Created**: `__tests__/BudgetProgressCard.test.tsx` - Component tests
- **Created**: `__tests__/budgetTrackingApi.test.ts` - API tests
- **Created**: `__tests__/budgetStoreTracking.test.ts` - Store tests
- **Modified**: `src/types/models.ts` - Added BudgetWithSpending interface and types
- **Modified**: `src/types/store.ts` - Extended budget store interface
- **Modified**: `src/services/api/budgets.ts` - Added tracking API methods
- **Modified**: `src/stores/budgetStore.ts` - Enhanced with tracking capabilities
- **Modified**: `src/components/budgets/BudgetsList.tsx` - Added progress display mode
- **Modified**: `app/(app)/budgets/index.tsx` - Integrated tracking functionality

---

## QA Results

Pending QA review.