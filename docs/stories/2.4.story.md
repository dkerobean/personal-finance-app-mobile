# Status

Draft

---

# Story

**As a** user,
**I want** the app to intelligently suggest categories for my synced transactions,
**so that** I can save time on manual organization.

---

# Acceptance Criteria

1. When new transactions are synced, a backend process attempts to assign a category based on the transaction description (e.g., "UBER" is categorized as "Transport").
2. A basic set of categorization rules is implemented.
3. Transactions that cannot be automatically categorized are marked as "Uncategorized".
4. The user can easily re-categorize any transaction.

Source: `docs/prd/epic-2-automated-account-integration.md#story-24-basic-automated-categorization`

---

# Tasks / Subtasks

- [ ] Categorization Rules Engine (AC: 1, 2)
  - [ ] Create CategorizationService with rule-based matching system
  - [ ] Implement keyword-based categorization logic (case-insensitive pattern matching)
  - [ ] Create categorization rules configuration (JSON/YAML file with patterns and category mappings)
  - [ ] Integrate categorization into transaction sync process from Story 2.2

- [ ] Default Category Rules (AC: 2)
  - [ ] Define basic categorization patterns:
    - Transport: "UBER", "BOLT", "LYFT", "TAXI", "BUS", "FUEL", "PETROL"
    - Food: "RESTAURANT", "MCDONALD", "KFC", "FOOD", "CAFE", "PIZZA"
    - Shopping: "MALL", "SHOP", "STORE", "AMAZON", "JUMIA", "MARKET"
    - Utilities: "ELECTRICITY", "WATER", "INTERNET", "PHONE", "BILL"
    - Income: "SALARY", "TRANSFER IN", "DEPOSIT", "PAYMENT RECEIVED"
  - [ ] Create default "Uncategorized" category for unmatched transactions [Source: architecture.md#Data Models → Categories]
  - [ ] Ensure categorization rules work with Ghana-specific merchant names

- [ ] Uncategorized Handling (AC: 3)
  - [ ] Create system "Uncategorized" category if it doesn't exist [Source: architecture.md#Data Models → Categories]
  - [ ] Assign unmatched transactions to Uncategorized category_id
  - [ ] Provide clear visual indication in UI for uncategorized transactions
  - [ ] Track categorization success rate for improvement insights

- [ ] Re-categorization Interface (AC: 4)
  - [ ] Update EditTransactionModal from Story 2.3 to highlight auto-categorized transactions
  - [ ] Create CategorySuggestionBadge to show "Auto-categorized" vs "Manual" status
  - [ ] Implement bulk re-categorization for similar transaction descriptions
  - [ ] Add "Improve categorization" feedback mechanism for learning

- [ ] Backend Integration
  - [ ] Add categorization logic to POST /accounts/{id}/sync process from Story 2.2
  - [ ] Create GET /categories/suggestions endpoint for re-categorization suggestions
  - [ ] Update transaction storage to track auto_categorized boolean flag [Source: architecture.md#Data Models → Transactions]
  - [ ] Implement categorization rule management (admin capability for future enhancement)

- [ ] Database Enhancements
  - [ ] Add auto_categorized field to transactions table schema [Source: architecture.md#Database Schema → Transactions Table]
  - [ ] Create categorization_rules table for persistent rule storage
  - [ ] Ensure default system categories exist for all users [Source: architecture.md#Data Models → Categories]
  - [ ] Add database indexes for efficient categorization queries

- [ ] Testing
  - [ ] Unit tests: Categorization rule matching with various transaction descriptions [Source: architecture.md#Testing Strategy → Backend Testing]
  - [ ] Integration tests: Full sync-to-categorization pipeline
  - [ ] Component tests: CategorySuggestionBadge and re-categorization UI
  - [ ] Performance tests: Categorization speed with large transaction volumes

---

# Dev Notes

## Previous Story Insights
Builds on Stories 2.1-2.3:
- Integrates with transaction sync process (2.2) to categorize during import
- Enhances transaction display (2.3) to show categorization status
- Requires existing category system from Epic 1 stories (1.3)

## Data Models
Extended Transaction model with categorization metadata: [Source: architecture.md#Data Models → Transactions]
```typescript
export interface Transaction {
  id: string; // UUID
  user_id: string; // UUID  
  account_id: string | null; // UUID
  category_id: string; // UUID - Auto-assigned or manual
  amount: number;
  type: 'income' | 'expense';
  description: string; // Used for categorization matching
  transaction_date: string; // ISO 8601 Timestamp
  is_synced: boolean;
  auto_categorized?: boolean; // New field to track categorization source
}
```

New categorization rules structure:
```typescript
export interface CategorizationRule {
  id: string;
  category_name: string;
  keywords: string[]; // Patterns to match in description
  priority: number; // Higher priority rules checked first
}
```

## API Specifications
New/updated endpoints: [Source: architecture.md#API Specification]
- Updated POST /accounts/{id}/sync: Include categorization in sync process
- New GET /categories/suggestions: Provide re-categorization suggestions based on similar descriptions
- Updated PATCH /transactions/{id}: Handle auto_categorized flag updates

## Component Specifications
UI components for categorization features: [Source: architecture.md#Frontend Architecture → Component Architecture]
- **CategorySuggestionBadge**: Visual indicator for auto vs manual categorization
- **BulkCategorizeModal**: Interface for re-categorizing similar transactions
- **CategorizationFeedback**: Component for improving rule accuracy
- Updates to existing EditTransactionModal for enhanced categorization

## File Locations
Backend categorization system: [Source: architecture.md#Unified Project Structure → Backend Repository]
- New: supabase/functions/shared/categorization-service.ts
- New: supabase/functions/shared/categorization-rules.json
- Update: supabase/functions/accounts-sync/ (integrate categorization)
- New: supabase/migrations/add_auto_categorized_field.sql

Frontend categorization UI: [Source: architecture.md#Unified Project Structure → Frontend Repository]
- New: src/components/transactions/CategorySuggestionBadge.tsx
- New: src/components/transactions/BulkCategorizeModal.tsx
- Update: src/components/transactions/EditTransactionModal.tsx
- New: src/services/categorizationService.ts

## Security Requirements
Categorization data security: [Source: architecture.md#Security Requirements]
- All categorization API calls require JWT authentication [Source: architecture.md#Security Requirements → Authentication Security]  
- RLS ensures users only access their categorization data [Source: architecture.md#Backend Architecture → Authentication and Authorization]
- Input validation on transaction descriptions to prevent injection attacks [Source: architecture.md#Security Requirements → Backend Security]

## State Management
Store updates for categorization: [Source: architecture.md#Frontend Architecture → State Management Architecture]
- Add categorization-related actions to transactionStore
- Create categoryStore selectors for uncategorized transaction counts
- Track categorization success metrics for analytics
- Handle real-time updates when transactions are re-categorized

## Business Logic
Categorization algorithm approach:
- Rule-based keyword matching (phase 1 - this story)
- Case-insensitive substring matching in transaction descriptions
- Priority-based rule evaluation (specific patterns before general)
- Fallback to "Uncategorized" for unmatched descriptions
- Future enhancement capability for ML-based categorization

## Testing Requirements
Comprehensive categorization testing: [Source: architecture.md#Testing Strategy]
- Rule accuracy testing with real Ghana transaction examples
- Performance testing with batch categorization operations
- UI testing for categorization status display and re-categorization flows
- Edge case handling: empty descriptions, special characters, multiple matches

## Technical Constraints
Performance and accuracy considerations:
- Categorization should not significantly slow transaction sync process
- Rule evaluation must be efficient for large transaction batches
- Support for Ghana-specific merchant names and banking terminology
- Maintain <200ms additional processing time for categorization [Source: architecture.md#Security and Performance → Performance Optimization]

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-12 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

### Agent Model Used
{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List

---

## QA Results

Pending QA review.