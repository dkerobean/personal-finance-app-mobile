# Status

Draft

---

# Story

**As a** user,
**I want** to modify, pause, and manage my existing savings goals as my financial situation changes,
**so that** I can keep my goals realistic and aligned with my current circumstances.

---

# Acceptance Criteria

1. The user can edit goal details including name, target amount, target date, and description after creation.
2. The user can pause and resume goals temporarily without losing progress or history.
3. The user can delete goals with appropriate warnings and data preservation options.
4. The user can adjust monthly savings targets and receive updated timeline projections.
5. The user can merge similar goals or split large goals into smaller, more manageable targets.
6. The user can archive completed goals while maintaining them in their achievement history.

Source: `docs/prd/epic-4-goal-setting-savings.md#story-45-goal-management-adjustments`

---

# Tasks / Subtasks

- [ ] Goal Editing Interface (AC: 1)
  - [ ] Create `EditGoalScreen` with pre-populated form fields [Source: architecture/source-tree.md#Frontend Repository Structure]
  - [ ] Implement field validation with current progress considerations
  - [ ] Add target amount adjustment with progress protection (cannot set below current amount)
  - [ ] Create target date modification with realistic timeline validation
  - [ ] Implement goal name and description editing with duplicate name checking
  - [ ] Add category change functionality with migration of existing data

- [ ] Goal Status Management (AC: 2)
  - [ ] Create `GoalStatusManager` service for state transitions [Source: architecture/source-tree.md#Service Organization]
  - [ ] Implement pause/resume functionality with status tracking
  - [ ] Add pause reason selection (temporary income reduction, other priorities, etc.)
  - [ ] Create resume workflow with timeline recalculation
  - [ ] Implement status history tracking for audit trail
  - [ ] Add notification system for paused goal reminders

- [ ] Goal Deletion & Archives (AC: 3, 6)
  - [ ] Create goal deletion workflow with confirmation dialogs
  - [ ] Implement soft delete with recovery option (30-day retention)
  - [ ] Add data export option before deletion (contribution history, milestones)
  - [ ] Create goal archival system for completed goals
  - [ ] Implement archive browsing and search functionality
  - [ ] Add archive restoration capability for accidentally archived goals

- [ ] Target Adjustment System (AC: 4)
  - [ ] Create `GoalAdjustmentCalculator` for timeline recalculation [Source: architecture/source-tree.md#Service Organization]
  - [ ] Implement monthly target modification with progress preservation
  - [ ] Add automatic timeline adjustment based on new targets
  - [ ] Create target change impact preview before confirmation
  - [ ] Implement adjustment history tracking and visualization
  - [ ] Add smart suggestions for realistic target adjustments

- [ ] Goal Merging & Splitting (AC: 5)
  - [ ] Create `GoalMerger` service for combining similar goals [Source: architecture/source-tree.md#Service Organization]
  - [ ] Implement goal selection interface for merging operations
  - [ ] Add contribution history consolidation during merge
  - [ ] Create goal splitting interface with amount distribution
  - [ ] Implement proportional contribution allocation for split goals
  - [ ] Add merge/split confirmation with detailed preview

- [ ] Goal Management UI Components (AC: All)
  - [ ] Design `GoalActionsMenu` with edit, pause, delete, and archive options [Source: architecture/source-tree.md#Component Structure]
  - [ ] Create `GoalEditForm` with validation and progress considerations
  - [ ] Implement `GoalStatusBadge` for visual status indication
  - [ ] Add `AdjustmentPreview` component for showing impact of changes
  - [ ] Create `MergeGoalsModal` for goal consolidation workflow
  - [ ] Design `SplitGoalModal` for goal division interface

- [ ] Backend Goal Management API (AC: All)
  - [ ] Extend `supabase/functions/goals/index.ts` with management endpoints [Source: architecture/source-tree.md#Backend Repository Structure]
  - [ ] Implement PUT /goals/:id endpoint for goal updates
  - [ ] Create PATCH /goals/:id/status endpoint for status changes
  - [ ] Add DELETE /goals/:id endpoint with soft delete logic
  - [ ] Implement POST /goals/merge endpoint for combining goals
  - [ ] Create POST /goals/:id/split endpoint for goal division
  - [ ] Add proper validation and business rule enforcement

- [ ] Data Integrity & History (AC: All)
  - [ ] Create goal modification audit log table [Source: architecture/tech-stack.md#Database]
  - [ ] Implement contribution history preservation during modifications
  - [ ] Add data validation for goal modifications with existing progress
  - [ ] Create milestone recalculation triggers for goal changes
  - [ ] Implement referential integrity for merged/split goals
  - [ ] Add data recovery mechanisms for accidental operations

- [ ] State Management Enhancement (AC: All)
  - [ ] Extend `src/stores/goalStore.ts` with management operations [Source: architecture/tech-stack.md#State Management]
  - [ ] Add goal status change state management
  - [ ] Implement edit mode state for goal modification
  - [ ] Create merge/split operation state tracking
  - [ ] Add optimistic updates for smooth user experience
  - [ ] Implement undo functionality for recent goal changes

- [ ] Services Integration (AC: All)
  - [ ] Extend `src/services/goalService.ts` with management operations [Source: architecture/source-tree.md#Service Organization]
  - [ ] Create goal validation service for edit operations
  - [ ] Implement goal status transition service
  - [ ] Add goal archival and restoration services
  - [ ] Create goal adjustment calculation services
  - [ ] Implement merge/split operation services

- [ ] Business Logic Validation (AC: All)
  - [ ] Implement goal editing business rules and constraints
  - [ ] Add progress preservation validation during modifications
  - [ ] Create timeline feasibility checks for target changes
  - [ ] Implement merge compatibility validation (similar categories, etc.)
  - [ ] Add split operation validation (minimum amounts, realistic targets)
  - [ ] Create status transition validation rules

- [ ] Notification & Communication (AC: All)
  - [ ] Create goal modification notification templates
  - [ ] Implement status change notifications (paused, resumed, modified)
  - [ ] Add goal adjustment confirmation messages
  - [ ] Create merge/split operation success communications
  - [ ] Implement warning notifications for risky modifications
  - [ ] Add progress impact notifications for major changes

- [ ] Testing (AC: All)
  - [ ] Unit tests: Goal modification logic, status transitions, business rules [Source: architecture/tech-stack.md#Frontend Testing]
  - [ ] Component tests: Edit forms, status management, merge/split interfaces [Source: architecture/tech-stack.md#Frontend Testing]
  - [ ] API tests: All goal management endpoints, data integrity [Source: architecture/tech-stack.md#Backend Testing]
  - [ ] Integration tests: End-to-end goal modification workflows
  - [ ] Data integrity tests: Contribution preservation, referential integrity
  - [ ] Edge case tests: Complex modification scenarios, error recovery

---

# Dev Notes

## Previous Story Dependencies
Building on Stories 4.1, 4.2, and 4.3 foundations:
- Requires goal data models and basic CRUD operations from Story 4.1
- Uses contribution data and progress tracking from Story 4.2
- May integrate with recommendation system from Story 4.3 for adjustment suggestions
- Leverages milestone and achievement systems from previous stories

## Data Models
Goal management data structures: [Source: architecture/tech-stack.md#Database]
```typescript
export interface GoalModification {
  id: string;
  goal_id: string;
  user_id: string;
  modification_type: 'edit' | 'pause' | 'resume' | 'archive' | 'delete' | 'merge' | 'split';
  old_values: Record<string, any>;
  new_values: Record<string, any>;
  reason?: string;
  created_at: string;
  created_by: string;
}

export interface GoalStatus {
  goal_id: string;
  status: 'active' | 'paused' | 'archived' | 'deleted' | 'completed';
  status_reason?: string;
  paused_at?: string;
  resumed_at?: string;
  archived_at?: string;
  deleted_at?: string;
  updated_at: string;
}

export interface GoalMergeOperation {
  id: string;
  user_id: string;
  source_goal_ids: string[];
  target_goal_id: string;
  merge_strategy: 'sum_amounts' | 'keep_latest_date' | 'average_targets';
  completed_at: string;
}

export interface GoalSplitOperation {
  id: string;
  user_id: string;
  source_goal_id: string;
  target_goal_ids: string[];
  split_amounts: number[];
  split_strategy: 'equal' | 'proportional' | 'manual';
  completed_at: string;
}
```

## Business Logic Rules
Goal management constraints and validation:
- **Edit Constraints**: Cannot reduce target amount below current progress
- **Date Validation**: New target date must be realistic based on current progress
- **Status Transitions**: Valid state machine for goal status changes
- **Merge Rules**: Goals must have compatible categories and currencies
- **Split Requirements**: Minimum split amount validation and realistic timeline
- **Deletion Protection**: Soft delete with recovery period and contribution preservation

## API Specifications
Goal management endpoints: [Source: architecture/tech-stack.md#API Style]
- PUT /goals/:id: Update goal details with validation
- PATCH /goals/:id/status: Change goal status (pause/resume/archive)
- DELETE /goals/:id: Soft delete with optional hard delete after retention
- POST /goals/merge: Merge multiple goals into one
- POST /goals/:id/split: Split goal into multiple goals
- GET /goals/:id/history: Get modification history and audit trail
- All endpoints require JWT authentication [Source: architecture/tech-stack.md#Authentication]

## Component Specifications
Goal management UI components: [Source: architecture/source-tree.md#Component Structure]
- **EditGoalForm**: Comprehensive goal editing with validation
- **GoalStatusManager**: Status change interface with reason selection
- **GoalActionsMenu**: Context menu for goal management actions
- **MergeGoalsModal**: Goal selection and merge configuration
- **SplitGoalModal**: Goal division with amount distribution
- **GoalHistoryView**: Modification audit trail display
- **AdjustmentPreview**: Impact preview for goal changes

## File Locations
Goal management implementation: [Source: architecture/source-tree.md#Frontend Repository Structure]
- Screens: `app/(app)/goals/edit/[id].tsx`, `goals/manage/[id].tsx`
- Components: `src/components/features/goals/EditGoalForm/`, `GoalStatusManager/`, `MergeGoalsModal/`
- Services: Extended `src/services/goalService.ts`, `goalManagementService.ts`
- Store: Enhanced `src/stores/goalStore.ts` with management operations
- Types: Extended `src/types/models.ts` with management interfaces

Backend goal management: [Source: architecture/source-tree.md#Backend Repository Structure]
- Edge Functions: Extended `supabase/functions/goals/index.ts` with management handlers
- Database: Migration for goal_modifications, goal_status, and operation tracking tables
- Services: Goal validation, status management, and operation services
- Triggers: Automatic milestone recalculation and contribution adjustments

## State Management Extensions
Enhanced goal store for management operations: [Source: architecture/tech-stack.md#State Management]
```typescript
interface GoalStore {
  // Existing from previous stories
  goals: Goal[];
  contributions: Contribution[];
  
  // New for management
  goalHistory: GoalModification[];
  editingGoal: Goal | null;
  pendingOperations: PendingOperation[];
  
  // Management Actions
  updateGoal: (id: string, updates: Partial<Goal>) => Promise<boolean>;
  changeGoalStatus: (id: string, status: GoalStatus, reason?: string) => Promise<boolean>;
  deleteGoal: (id: string, preserveData: boolean) => Promise<boolean>;
  mergeGoals: (sourceIds: string[], targetGoal: Partial<Goal>) => Promise<string>;
  splitGoal: (id: string, splits: GoalSplit[]) => Promise<string[]>;
  
  // Management Selectors
  getGoalHistory: (id: string) => GoalModification[];
  canEditGoal: (id: string) => boolean;
  getMergeableGoals: (goalId: string) => Goal[];
  getSplitPreview: (id: string, splits: number[]) => GoalSplit[];
}
```

## Data Integrity Mechanisms
Ensuring data consistency during goal management:
- **Contribution Preservation**: Maintain contribution history during all modifications
- **Milestone Recalculation**: Automatic milestone adjustment after goal changes
- **Referential Integrity**: Proper foreign key relationships for merged/split goals
- **Audit Trail**: Complete modification history with rollback capability
- **Validation Rules**: Business logic enforcement at database and application levels
- **Transaction Safety**: Atomic operations for complex modifications like merge/split

## Status Transition System
Goal status management state machine:
```typescript
interface GoalStatusMachine {
  // Valid Transitions
  active: ['paused', 'archived', 'completed', 'deleted'];
  paused: ['active', 'archived', 'deleted'];
  archived: ['active', 'deleted'];
  completed: ['archived', 'active']; // for goal restoration
  deleted: ['active']; // during recovery period only
  
  // Transition Validation
  validateTransition: (from: GoalStatus, to: GoalStatus) => boolean;
  executeTransition: (goalId: string, newStatus: GoalStatus, reason?: string) => Promise<boolean>;
}
```

## Merge & Split Operations
Complex goal operation handling:
- **Merge Strategy**: Combine target amounts, take latest target date, preserve all contributions
- **Split Strategy**: Proportional amount distribution, maintain original timeline, divide contributions
- **Data Migration**: Move contributions and milestones to new goal structure
- **History Tracking**: Maintain audit trail showing original goals and operations performed
- **Validation**: Ensure merge/split operations result in valid, achievable goals
- **Rollback**: Ability to reverse merge/split operations within limited time window

## Performance Considerations
Goal management system optimization: [Source: architecture/tech-stack.md#Performance]
- **Optimistic Updates**: Immediate UI feedback with background synchronization
- **Batch Operations**: Efficient processing of bulk goal modifications
- **History Pagination**: Efficient loading of goal modification history
- **Caching Strategy**: Smart caching of goal states and modification data
- **Database Optimization**: Proper indexing for goal management queries
- **Background Processing**: Heavy operations (merge/split) handled asynchronously

## Security & Permissions
Goal management access control: [Source: architecture/tech-stack.md#Security]
- **User Authorization**: Verify user ownership before any goal modifications
- **Operation Validation**: Ensure all modifications comply with business rules
- **Audit Logging**: Complete trail of who changed what and when
- **Data Protection**: Secure handling of goal modification data
- **Recovery Controls**: Time-limited recovery options with proper authentication
- **Rate Limiting**: Prevent abuse of goal management operations

## User Experience Considerations
Intuitive goal management interface:
- **Clear Confirmations**: Detailed previews before destructive operations
- **Progressive Disclosure**: Advanced options available but not overwhelming
- **Undo Capabilities**: Recent action reversal for accidental modifications
- **Status Indicators**: Clear visual feedback for goal states and operations
- **Help Context**: Contextual help for complex operations like merge/split
- **Error Recovery**: Graceful handling of failed operations with clear next steps

## Testing Requirements
Comprehensive goal management testing: [Source: architecture/tech-stack.md#Testing]
- Unit tests: Business logic validation, status transitions, operation algorithms
- Component tests: Edit forms, status management, merge/split interfaces
- API tests: All management endpoints, data integrity verification
- Integration tests: End-to-end goal modification and complex operation workflows
- Data integrity tests: Contribution preservation, referential integrity maintenance
- Performance tests: Bulk operations and complex data migrations
- Edge cases: Concurrent modifications, network failures, partial operation completion

## UI/UX Requirements
Goal management interface design:
- **Intuitive Edit Flow**: Clear, guided process for goal modifications
- **Visual Status Indication**: Unmistakable goal status representation
- **Operation Previews**: Clear impact visualization before confirming changes
- **Contextual Actions**: Relevant management options based on goal state
- **Error Prevention**: Validation and warnings to prevent invalid operations
- **Recovery Options**: Easy access to undo and recovery functionality

---

# Change Log

| Date       | Version | Description                               | Author |
| ---------- | ------- | ----------------------------------------- | ------ |
| 2025-08-24 | 1.0     | Initial story draft created (SM)          | Bob    |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation*

---

## QA Results

*This section will be populated by the QA agent during testing*